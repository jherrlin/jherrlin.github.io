<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-05-05 Sun 14:49 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>How I use Emacs org-mode to generate bash scripts</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="John Herrlin" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">How I use Emacs org-mode to generate bash scripts</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org6b8cd27">1. Abstract</a></li>
<li><a href="#org85596ad">2. The stuff</a>
<ul>
<li><a href="#orgb99af3d">2.1. The setup</a></li>
<li><a href="#org187b1ef">2.2. The problem</a></li>
<li><a href="#orgaaa14cf">2.3. The solution</a>
<ul>
<li><a href="#org509e112">2.3.1. Org mode tables</a></li>
<li><a href="#org20690a4">2.3.2. Org mode source code blocks and babel</a></li>
<li><a href="#orgd19fee4">2.3.3. Generate a bash script</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbcc007d">3. Discussion</a></li>
</ul>
</div>
</div>


<div id="outline-container-org6b8cd27" class="outline-2">
<h2 id="org6b8cd27"><span class="section-number-2">1</span> Abstract</h2>
<div class="outline-text-2" id="text-1">
<p>
Example of how to use Emacs, Org mode and Clojure to generate a bash script.
</p>
</div>
</div>

<div id="outline-container-org85596ad" class="outline-2">
<h2 id="org85596ad"><span class="section-number-2">2</span> The stuff</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgb99af3d" class="outline-3">
<h3 id="orgb99af3d"><span class="section-number-3">2.1</span> The setup</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Our environment is primary based on Heroku and AWS. Heroku is hosting our Clojure /
ClojureScript apps and AWS EC2 instances hosts our MongoDBs. We have 2 DB servers, one
for production and one for staging. The database name is the same as the Heroku app
name. So the Heroku app <code>customer1-prod</code> have a database with the name
<code>customer1-prod</code>. Each customer have 2 Heroku apps, one for staging and one for
production. The stage app is used for our manual testing with the customers data before
we depoy to production. The production app is the app the customer is using.
</p>
</div>
</div>


<div id="outline-container-org187b1ef" class="outline-3">
<h3 id="org187b1ef"><span class="section-number-3">2.2</span> The problem</h3>
<div class="outline-text-3" id="text-2-2">
<p>
We are a small company with just 3 customer at the moment, but we are growing and
more customers are joining in a rapid speed. I wanna have a simple way of copying the
production database to the staging database. This way we can test changes on the
state app before we put new code to production.
</p>
</div>
</div>

<div id="outline-container-orgaaa14cf" class="outline-3">
<h3 id="orgaaa14cf"><span class="section-number-3">2.3</span> The solution</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-org509e112" class="outline-4">
<h4 id="org509e112"><span class="section-number-4">2.3.1</span> Org mode tables</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
First of I am using GNU/Linux. I dont wanna install much extra fluff to be able to
handle this. I think a bash script could be nice! But I dont want to manually write
and later maintain it. The risk of typos, mixing up stuff or forgetting things is to
big (I am too much of a dumbass and needs a <a href="https://medium.com/@tasshin/implementing-a-second-brain-in-emacs-and-org-mode-ef0e44fb7ca5">second brain</a>).
</p>

<p>
I am using Emacs and Org mode for my day to day tasks and I wanted to solve this
problem with this tools. At work we use Clojure and I am pretty familiar with it. By
combining features of Org mode and Clojure I could maybe figure something out.
</p>

<p>
Below is a <a href="https://orgmode.org/manual/Tables.html">Org mode table</a> with the customers and the address to the respective
database.
</p>

<p>
Make a note about the <code>#+NAME: heroku-apps</code> in top of the table, this is important and
I will explain later.
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #7F9F7F;">#+NAME: heroku-apps</span>
<span style="color: #9FC59F;">| Heroku app name | AWS MongoDB host                                     |</span>
<span style="color: #9FC59F;">|-----------------+------------------------------------------------------|</span>
<span style="color: #9FC59F;">| customer1-stage | lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com |</span>
<span style="color: #9FC59F;">| customer1-prod  | jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com |</span>
<span style="color: #9FC59F;">| customer2-stage | lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com |</span>
<span style="color: #9FC59F;">| customer2-prod  | jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com |</span>
<span style="color: #9FC59F;">| customer3-stage | lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com |</span>
<span style="color: #9FC59F;">| customer3-prod  | jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com |</span>
</pre>
</div>

<p>
First of all I want to structure the table into something more easy to use in
Clojureland.
</p>
</div>
</div>

<div id="outline-container-org20690a4" class="outline-4">
<h4 id="org20690a4"><span class="section-number-4">2.3.2</span> Org mode source code blocks and babel</h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
Org mode have a feature called <a href="https://orgmode.org/worg/org-contrib/babel/">babel</a>. It allows you to write code within <code>#+begin_src</code>
blocks and execute them. By combinging Org mode tables and babel you can have the
table as an input variable to the babel code. In the table we named it <code>heroku-apps</code>
and in the code block below we have a heading with <code>:var ORGTABLE=heroku-apps</code>. This
makes the table available in the snippet as the variable <code>ORGTABLE</code>.
</p>

<p>
This is how clojure will represent the Org mode table. The <code>#+RESULTS:</code> part is the
output after execution of the snippet.
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #7F9F7F;">#+BEGIN_SRC clojure :var ORGTABLE=heroku-apps :results output code</span>
<span style="color: #b3b3b3;">      </span><span style="color: #DCDCCC;">(</span><span style="color: #7CB8BB;">clojure.pprint</span><span style="color: #b3b3b3;">/pprint ORGTABLE</span><span style="color: #DCDCCC;">)</span>
<span style="color: #7F9F7F;">#+END_SRC</span>

<span style="color: #7F9F7F;">#+RESULTS:</span>
<span style="color: #7F9F7F;">#+begin_src clojure</span>
<span style="color: #b3b3b3;">    </span><span style="color: #DCDCCC;">(</span><span style="color: #BFEBBF;">(</span><span style="color: #CC9393;">"customer1-stage"</span>
<span style="color: #b3b3b3;">      </span><span style="color: #CC9393;">"lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com"</span><span style="color: #BFEBBF;">)</span>
<span style="color: #b3b3b3;">     </span><span style="color: #BFEBBF;">(</span><span style="color: #CC9393;">"customer1-prod"</span>
<span style="color: #b3b3b3;">      </span><span style="color: #CC9393;">"jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com"</span><span style="color: #BFEBBF;">)</span>
<span style="color: #b3b3b3;">     </span><span style="color: #BFEBBF;">(</span><span style="color: #CC9393;">"customer2-stage"</span>
<span style="color: #b3b3b3;">      </span><span style="color: #CC9393;">"lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com"</span><span style="color: #BFEBBF;">)</span>
<span style="color: #b3b3b3;">     </span><span style="color: #BFEBBF;">(</span><span style="color: #CC9393;">"customer2-prod"</span>
<span style="color: #b3b3b3;">      </span><span style="color: #CC9393;">"jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com"</span><span style="color: #BFEBBF;">)</span>
<span style="color: #b3b3b3;">     </span><span style="color: #BFEBBF;">(</span><span style="color: #CC9393;">"customer3-stage"</span>
<span style="color: #b3b3b3;">      </span><span style="color: #CC9393;">"lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com"</span><span style="color: #BFEBBF;">)</span>
<span style="color: #b3b3b3;">     </span><span style="color: #BFEBBF;">(</span><span style="color: #CC9393;">"customer3-prod"</span>
<span style="color: #b3b3b3;">      </span><span style="color: #CC9393;">"jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com"</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #7F9F7F;">#+end_src</span>
</pre>
</div>


<p>
The datastructure is a list with lists inside. I want to have it a little more
structured to be able to work with it. The snippet bellow makes it easier for me to
reason about it. The datastructure is a <a href="https://clojuredocs.org/clojure.core/hash-map">hash-map</a> with hash-maps for each customer. In
Clojure this will be very easy to work with.
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="color: #7F9F7F;">#+BEGIN_SRC clojure :var ORGTABLE=heroku-apps :results output code</span>
<span style="color: #b3b3b3;">      </span><span style="color: #DCDCCC;">(</span><span style="color: #7CB8BB;">clojure.pprint</span><span style="color: #b3b3b3;">/pprint</span>
<span style="color: #b3b3b3;">       </span><span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">-&gt;&gt;</span><span style="color: #b3b3b3;"> ORGTABLE</span>
<span style="color: #b3b3b3;">            </span><span style="color: #D0BF8F;">(</span><span style="color: #b3b3b3;">reduce </span><span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">fn</span><span style="color: #b3b3b3;"> </span><span style="color: #9FC59F;">[</span><span style="color: #b3b3b3;">new-hashmap </span><span style="color: #94BFF3;">[</span><span style="color: #b3b3b3;">app-name db-host</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">]</span>
<span style="color: #b3b3b3;">                      </span><span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span><span style="color: #b3b3b3;"> </span><span style="color: #94BFF3;">[</span><span style="color: #E0CF9F;">[</span><span style="color: #b3b3b3;">_ customer env</span><span style="color: #E0CF9F;">]</span><span style="color: #b3b3b3;"> </span><span style="color: #E0CF9F;">(</span><span style="color: #b3b3b3;">re-matches #</span><span style="color: #CC9393;">"^</span><span style="color: #F0DFAF; font-weight: bold;">(</span><span style="color: #CC9393;">.+</span><span style="color: #F0DFAF; font-weight: bold;">)</span><span style="color: #CC9393;">-</span><span style="color: #F0DFAF; font-weight: bold;">(</span><span style="color: #CC9393;">.+</span><span style="color: #F0DFAF; font-weight: bold;">)</span><span style="color: #CC9393;">$"</span><span style="color: #b3b3b3;"> app-name</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
<span style="color: #b3b3b3;">                        </span><span style="color: #94BFF3;">(</span><span style="color: #b3b3b3;">update new-hashmap customer merge </span><span style="color: #E0CF9F;">{</span><span style="color: #8FB28F;">(</span><span style="color: #b3b3b3;">keyword </span><span style="color: #6CA0A3;">(</span><span style="color: #b3b3b3;">str </span><span style="color: #CC9393;">"app-name-"</span><span style="color: #b3b3b3;"> env</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #b3b3b3;"> app-name</span>
<span style="color: #b3b3b3;">                                                            </span><span style="color: #8FB28F;">(</span><span style="color: #b3b3b3;">keyword </span><span style="color: #6CA0A3;">(</span><span style="color: #b3b3b3;">str </span><span style="color: #CC9393;">"db-host-"</span><span style="color: #b3b3b3;"> env</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #b3b3b3;"> db-host</span><span style="color: #E0CF9F;">}</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
<span style="color: #b3b3b3;">                    </span><span style="color: #93E0E3;">{}</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
<span style="color: #7F9F7F;">#+END_SRC</span>

<span style="color: #7F9F7F;">#+RESULTS:</span>
<span style="color: #7F9F7F;">#+begin_src clojure</span>
<span style="color: #b3b3b3;">  </span><span style="color: #DCDCCC;">{</span><span style="color: #CC9393;">"customer1"</span>
<span style="color: #b3b3b3;">   </span><span style="color: #BFEBBF;">{</span><span style="color: #BFEBBF;">:app-name-stage</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">"customer1-stage"</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">:db-host-stage</span><span style="color: #b3b3b3;">  </span><span style="color: #CC9393;">"lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com"</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">:app-name-prod</span><span style="color: #b3b3b3;">  </span><span style="color: #CC9393;">"customer1-prod"</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">:db-host-prod</span><span style="color: #b3b3b3;">   </span><span style="color: #CC9393;">"jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com"</span><span style="color: #BFEBBF;">}</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">   </span><span style="color: #CC9393;">"customer2"</span>
<span style="color: #b3b3b3;">   </span><span style="color: #BFEBBF;">{</span><span style="color: #BFEBBF;">:app-name-stage</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">"customer2-stage"</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">:db-host-stage</span><span style="color: #b3b3b3;">  </span><span style="color: #CC9393;">"lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com"</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">:app-name-prod</span><span style="color: #b3b3b3;">  </span><span style="color: #CC9393;">"customer2-prod"</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">:db-host-prod</span><span style="color: #b3b3b3;">   </span><span style="color: #CC9393;">"jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com"</span><span style="color: #BFEBBF;">}</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">   </span><span style="color: #CC9393;">"customer3"</span>
<span style="color: #b3b3b3;">   </span><span style="color: #BFEBBF;">{</span><span style="color: #BFEBBF;">:app-name-stage</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">"customer3-stage"</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">:db-host-stage</span><span style="color: #b3b3b3;">  </span><span style="color: #CC9393;">"lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com"</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">:app-name-prod</span><span style="color: #b3b3b3;">  </span><span style="color: #CC9393;">"customer3-prod"</span><span style="color: #b3b3b3;">,</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">:db-host-prod</span><span style="color: #b3b3b3;">   </span><span style="color: #CC9393;">"jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com"</span><span style="color: #BFEBBF;">}</span><span style="color: #DCDCCC;">}</span>
<span style="color: #7F9F7F;">#+end_src</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-orgd19fee4" class="outline-4">
<h4 id="orgd19fee4"><span class="section-number-4">2.3.3</span> Generate a bash script</h4>
<div class="outline-text-4" id="text-2-3-3">
<p>
Now when I have the Org mode table in a good datastructure it&rsquo;s time to generate the
bash script. A <a href="https://clojuredocs.org/clojure.core/reduce">reduce</a> can be helpful to go through the hash-map and genereate a
string. The snippet bellow goes through the hash-map. For every customer it generates
a <code>mongodump</code>, <code>mongorestore</code> command and then removes folder produced by <code>mongodump</code>.
</p>


<div class="org-src-container">
<pre class="src src-org"><span style="color: #7F9F7F;">#+BEGIN_SRC clojure :var ORGTABLE=heroku-apps :results output code</span>
<span style="color: #b3b3b3;">  </span><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">do</span>
<span style="color: #b3b3b3;">    </span><span style="color: #BFEBBF;">(</span><span style="color: #b3b3b3;">println</span>
<span style="color: #b3b3b3;">     </span><span style="color: #D0BF8F;">(</span><span style="color: #b3b3b3;">reduce </span><span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">fn</span><span style="color: #b3b3b3;"> </span><span style="color: #9FC59F;">[</span><span style="color: #b3b3b3;">new-string </span><span style="color: #94BFF3;">[</span><span style="color: #b3b3b3;">customer h</span><span style="color: #94BFF3;">]</span><span style="color: #9FC59F;">]</span>
<span style="color: #b3b3b3;">               </span><span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span><span style="color: #b3b3b3;"> </span><span style="color: #94BFF3;">[</span><span style="color: #b3b3b3;">fill </span><span style="color: #E0CF9F;">(</span><span style="color: #7CB8BB;">clojure.string</span><span style="color: #b3b3b3;">/join </span><span style="color: #CC9393;">""</span><span style="color: #b3b3b3;"> </span><span style="color: #8FB28F;">(</span><span style="color: #b3b3b3;">repeat 25 </span><span style="color: #CC9393;">"-"</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span>
<span style="color: #b3b3b3;">                     fills </span><span style="color: #E0CF9F;">(</span><span style="color: #b3b3b3;">str </span><span style="color: #CC9393;">"echo </span><span style="color: #CC9393; font-weight: bold;">\"</span><span style="color: #CC9393;">"</span><span style="color: #b3b3b3;"> fill </span><span style="color: #8FB28F;">(</span><span style="color: #7CB8BB;">clojure.string</span><span style="color: #b3b3b3;">/upper-case customer</span><span style="color: #8FB28F;">)</span><span style="color: #b3b3b3;"> fill </span><span style="color: #CC9393;">"</span><span style="color: #CC9393; font-weight: bold;">\"\n</span><span style="color: #CC9393;">"</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">]</span>
<span style="color: #b3b3b3;">                 </span><span style="color: #94BFF3;">(</span><span style="color: #b3b3b3;">str new-string</span>
<span style="color: #b3b3b3;">                      fills</span>
<span style="color: #b3b3b3;">                      </span><span style="color: #CC9393;">"mongodump --gzip --host "</span><span style="color: #b3b3b3;"> </span><span style="color: #E0CF9F;">(</span><span style="color: #BFEBBF;">:db-host-prod</span><span style="color: #b3b3b3;"> h</span><span style="color: #E0CF9F;">)</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">" --db "</span><span style="color: #b3b3b3;"> </span><span style="color: #E0CF9F;">(</span><span style="color: #BFEBBF;">:app-name-prod</span><span style="color: #b3b3b3;"> h</span><span style="color: #E0CF9F;">)</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">" --ssl --out /tmp/db-dumps/ </span><span style="color: #CC9393; font-weight: bold;">\n</span><span style="color: #CC9393;">"</span>
<span style="color: #b3b3b3;">                      </span><span style="color: #CC9393;">"mongorestore --drop --gzip --host "</span><span style="color: #b3b3b3;"> </span><span style="color: #E0CF9F;">(</span><span style="color: #BFEBBF;">:db-host-stage</span><span style="color: #b3b3b3;"> h</span><span style="color: #E0CF9F;">)</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">" --db "</span><span style="color: #b3b3b3;"> </span><span style="color: #E0CF9F;">(</span><span style="color: #BFEBBF;">:app-name-stage</span><span style="color: #b3b3b3;"> h</span><span style="color: #E0CF9F;">)</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">" --ssl /tmp/db-dumps/"</span><span style="color: #b3b3b3;"> </span><span style="color: #E0CF9F;">(</span><span style="color: #BFEBBF;">:app-name-prod</span><span style="color: #b3b3b3;"> h</span><span style="color: #E0CF9F;">)</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">"</span><span style="color: #CC9393; font-weight: bold;">\n</span><span style="color: #CC9393;">"</span>
<span style="color: #b3b3b3;">                      </span><span style="color: #CC9393;">"rm -rf /tmp/"</span><span style="color: #b3b3b3;"> </span><span style="color: #E0CF9F;">(</span><span style="color: #BFEBBF;">:app-name-prod</span><span style="color: #b3b3b3;"> h</span><span style="color: #E0CF9F;">)</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">"</span><span style="color: #CC9393; font-weight: bold;">\n</span><span style="color: #CC9393;">"</span>
<span style="color: #b3b3b3;">                      fills</span>
<span style="color: #b3b3b3;">                      </span><span style="color: #CC9393;">"</span><span style="color: #CC9393; font-weight: bold;">\n</span><span style="color: #CC9393;">"</span>
<span style="color: #b3b3b3;">                      </span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
<span style="color: #b3b3b3;">               </span><span style="color: #93E0E3;">)</span>
<span style="color: #b3b3b3;">             </span><span style="color: #93E0E3;">(</span><span style="color: #b3b3b3;">str </span><span style="color: #CC9393;">"#!/usr/bin/env bash</span><span style="color: #CC9393; font-weight: bold;">\n\n</span><span style="color: #CC9393;">"</span>
<span style="color: #b3b3b3;">                  </span><span style="color: #CC9393;">"# This script will copy the production databases to the stage databases</span><span style="color: #CC9393; font-weight: bold;">\n</span><span style="color: #CC9393;">"</span>
<span style="color: #b3b3b3;">                  </span><span style="color: #CC9393;">"# Generated: "</span><span style="color: #b3b3b3;"> </span><span style="color: #9FC59F;">(</span><span style="color: #b3b3b3;">.format </span><span style="color: #94BFF3;">(</span><span style="color: #b3b3b3;">java.text.SimpleDateFormat. </span><span style="color: #CC9393;">"yyy-dd-MM HH:mm:ss"</span><span style="color: #94BFF3;">)</span><span style="color: #b3b3b3;"> </span><span style="color: #94BFF3;">(</span><span style="color: #b3b3b3;">java.util.Date.</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #b3b3b3;"> </span><span style="color: #CC9393;">"</span><span style="color: #CC9393; font-weight: bold;">\n\n\n</span><span style="color: #CC9393;">"</span><span style="color: #93E0E3;">)</span>
<span style="color: #b3b3b3;">             </span><span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">-&gt;&gt;</span><span style="color: #b3b3b3;"> ORGTABLE</span>
<span style="color: #b3b3b3;">                  </span><span style="color: #9FC59F;">(</span><span style="color: #b3b3b3;">reduce </span><span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">fn</span><span style="color: #b3b3b3;"> </span><span style="color: #E0CF9F;">[</span><span style="color: #b3b3b3;">new-hashmap </span><span style="color: #8FB28F;">[</span><span style="color: #b3b3b3;">app-name db-host</span><span style="color: #8FB28F;">]</span><span style="color: #E0CF9F;">]</span>
<span style="color: #b3b3b3;">                            </span><span style="color: #E0CF9F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span><span style="color: #b3b3b3;"> </span><span style="color: #8FB28F;">[</span><span style="color: #6CA0A3;">[</span><span style="color: #b3b3b3;">_ customer env</span><span style="color: #6CA0A3;">]</span><span style="color: #b3b3b3;"> </span><span style="color: #6CA0A3;">(</span><span style="color: #b3b3b3;">re-matches #</span><span style="color: #CC9393;">"^</span><span style="color: #F0DFAF; font-weight: bold;">(</span><span style="color: #CC9393;">.+</span><span style="color: #F0DFAF; font-weight: bold;">)</span><span style="color: #CC9393;">-</span><span style="color: #F0DFAF; font-weight: bold;">(</span><span style="color: #CC9393;">.+</span><span style="color: #F0DFAF; font-weight: bold;">)</span><span style="color: #CC9393;">$"</span><span style="color: #b3b3b3;"> app-name</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">]</span>
<span style="color: #b3b3b3;">                              </span><span style="color: #8FB28F;">(</span><span style="color: #b3b3b3;">update new-hashmap customer merge </span><span style="color: #6CA0A3;">{</span><span style="color: #DCDCCC;">(</span><span style="color: #b3b3b3;">keyword </span><span style="color: #BFEBBF;">(</span><span style="color: #b3b3b3;">str </span><span style="color: #CC9393;">"app-name-"</span><span style="color: #b3b3b3;"> env</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span><span style="color: #b3b3b3;"> app-name</span>
<span style="color: #b3b3b3;">                                                                  </span><span style="color: #DCDCCC;">(</span><span style="color: #b3b3b3;">keyword </span><span style="color: #BFEBBF;">(</span><span style="color: #b3b3b3;">str </span><span style="color: #CC9393;">"db-host-"</span><span style="color: #b3b3b3;"> env</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span><span style="color: #b3b3b3;"> db-host</span><span style="color: #6CA0A3;">}</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
<span style="color: #b3b3b3;">                          </span><span style="color: #94BFF3;">{}</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
<span style="color: #b3b3b3;">    'exit</span><span style="color: #DCDCCC;">)</span>
<span style="color: #7F9F7F;">#+END_SRC</span>

<span style="color: #7F9F7F;">#+RESULTS:</span>
<span style="color: #7F9F7F;">#+begin_src clojure</span>
<span style="color: #b3b3b3;">      </span><span style="color: #7CB8BB;">#!</span><span style="color: #b3b3b3;">/usr/bin/env bash</span>

<span style="color: #b3b3b3;">      # This script will copy the production databases to the stage databases</span>
<span style="color: #b3b3b3;">      # Generated: 2019-05-05 12:59:48</span>


<span style="color: #b3b3b3;">      echo </span><span style="color: #CC9393;">"-------------------------CUSTOMER1-------------------------"</span>
<span style="color: #b3b3b3;">      mongodump --gzip --host jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com --db customer1-prod --ssl --out </span><span style="color: #7CB8BB;">/tmp</span><span style="color: #b3b3b3;">/db-dumps/</span>
<span style="color: #b3b3b3;">      mongorestore --drop --gzip --host lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com --db customer1-stage --ssl </span><span style="color: #7CB8BB;">/tmp</span><span style="color: #b3b3b3;">/db-dumps/customer1-prod</span>
<span style="color: #b3b3b3;">      rm -rf </span><span style="color: #7CB8BB;">/tmp</span><span style="color: #b3b3b3;">/customer1-prod</span>
<span style="color: #b3b3b3;">      echo </span><span style="color: #CC9393;">"-------------------------CUSTOMER1-------------------------"</span>

<span style="color: #b3b3b3;">      echo </span><span style="color: #CC9393;">"-------------------------CUSTOMER2-------------------------"</span>
<span style="color: #b3b3b3;">      mongodump --gzip --host jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com --db customer2-prod --ssl --out </span><span style="color: #7CB8BB;">/tmp</span><span style="color: #b3b3b3;">/db-dumps/</span>
<span style="color: #b3b3b3;">      mongorestore --drop --gzip --host lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com --db customer2-stage --ssl </span><span style="color: #7CB8BB;">/tmp</span><span style="color: #b3b3b3;">/db-dumps/customer2-prod</span>
<span style="color: #b3b3b3;">      rm -rf </span><span style="color: #7CB8BB;">/tmp</span><span style="color: #b3b3b3;">/customer2-prod</span>
<span style="color: #b3b3b3;">      echo </span><span style="color: #CC9393;">"-------------------------CUSTOMER2-------------------------"</span>

<span style="color: #b3b3b3;">      echo </span><span style="color: #CC9393;">"-------------------------CUSTOMER3-------------------------"</span>
<span style="color: #b3b3b3;">      mongodump --gzip --host jnlwdavhxhmmhtemxcwf.eu-west-1.compute.amazonaws.com --db customer3-prod --ssl --out </span><span style="color: #7CB8BB;">/tmp</span><span style="color: #b3b3b3;">/db-dumps/</span>
<span style="color: #b3b3b3;">      mongorestore --drop --gzip --host lyvyprpzxhpcmgmnccou.eu-west-1.compute.amazonaws.com --db customer3-stage --ssl </span><span style="color: #7CB8BB;">/tmp</span><span style="color: #b3b3b3;">/db-dumps/customer3-prod</span>
<span style="color: #b3b3b3;">      rm -rf </span><span style="color: #7CB8BB;">/tmp</span><span style="color: #b3b3b3;">/customer3-prod</span>
<span style="color: #b3b3b3;">      echo </span><span style="color: #CC9393;">"-------------------------CUSTOMER3-------------------------"</span>


<span style="color: #b3b3b3;">      exit</span>
<span style="color: #7F9F7F;">#+end_src</span>
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-orgbcc007d" class="outline-2">
<h2 id="orgbcc007d"><span class="section-number-2">3</span> Discussion</h2>
<div class="outline-text-2" id="text-3">
<p>
When we get new customers on board I can simply update the Org mode table and run
<code>org-babel-execute-buffer</code> and it will produce a new script for me. I dont need to
copy-paste and search-replace anymore!
</p>

<p>
Org mode have some other features like <a href="https://orgmode.org/manual/Extracting-source-code.html">tangle</a> and <a href="https://www.emacswiki.org/emacs/TrampMode">tramp</a> that can be useful in
combination with the stuff mentioned in this post.
</p>

<p>
When I started using Org mode I found this post which was an eye opener
<a href="http://www.howardism.org/Technical/Emacs/literate-devops.html">http://www.howardism.org/Technical/Emacs/literate-devops.html</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2019-05-05 Sun 00:00</p>
<p class="author">Author: John Herrlin</p>
<p class="date">Created: 2019-05-05 Sun 14:49</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
