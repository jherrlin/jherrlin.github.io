<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Entity event log in Datomic | jherrlin</title>

<meta property='og:title' content='Entity event log in Datomic - jherrlin'>
<meta property='og:description' content='TL;DR Create an event log from Datomic transactions that&#39;s related to an entity. Look at transaction metadata, diffs and the entity from different angles.
Intro I am pretty new to Datomic and writing a small Clojure app. In my domain models I have a model called event-log. This model is used to keep track of changes (mutations) in the system. It have the following attributes: author, datetime, entity, id, type.'>
<meta property='og:url' content='https://jherrlin.github.io/posts/datomic-entity-event-log/'>
<meta property='og:site_name' content='jherrlin'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/4bc4e51875ff5d86326b676d50864a2c?s=256'><meta property='article:section' content='Posts'><meta property='article:tag' content='database'><meta property='article:tag' content='datomic'><meta property='article:tag' content='clojure'><meta property='article:tag' content='programming'><meta property='article:published_time' content='2020-05-17T20:28:11&#43;02:00'/><meta property='article:modified_time' content='2020-05-17T20:28:11&#43;02:00'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@jherrlin'><meta name='twitter:creator' content='@jherrlin'>


<link href="https://jherrlin.github.io/index.xml" rel="alternate" type="application/rss+xml" title="jherrlin" />

<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://jherrlin.github.io/posts/datomic-entity-event-log/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://jherrlin.github.io/">
          <h1 id="nav-heading" class="title is-4">jherrlin</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/jherrlin'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/jherrlin'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:jherrlin@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/john-herrlin-63458280'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="rss" href='/index.xml'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/database/">#database</a>



  
  | <a class="subtitle is-6" href="/tags/datomic/">#datomic</a>
  
  | <a class="subtitle is-6" href="/tags/clojure/">#clojure</a>
  
  | <a class="subtitle is-6" href="/tags/programming/">#programming</a>
  


      
    </div>
    <h2 class="subtitle is-6">May 17, 2020</h2>
    <h1 class="title">Entity event log in Datomic</h1>
    
    <div class="content">
      
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
TL;DR
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<p>
  Create an event log from Datomic transactions that&#39;s related to an entity. Look at
  transaction metadata, diffs and the entity from different angles.</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-2">
<h2 id="headline-2">
Intro
</h2>
<div id="outline-text-headline-2" class="outline-text-2">
<p>
  I am pretty new to Datomic and writing a small Clojure app. In my domain models I have a
  model called <em>event-log</em>. This model is used to keep track of changes (mutations) in the
  system. It have the following attributes: <em>author</em>, <em>datetime</em>, <em>entity</em>, <em>id</em>, <em>type</em>.
  <em>author</em> is the user that made the change, <em>entity</em> is a reference to the entity that&#39;s
  changed, <em>datetime</em> is a timestamp of when the change occurred, <em>id</em> is a unique
  identifier of the event log entity and <em>type</em> is a categorization of the change. If a
  change was successful an <em>event-log</em> entity would be created. This implies that for each
  change, a new <em>event-log</em> entity will be created.</p>
<p>
  After watching <a href="https://www.youtube.com/watch?v=7lm3K8zVOdY">this</a> talk I started to wonder if the <em>event-log</em> model was really needed
  in this app (it have only one database). Features of Datomic maybe could replace this
  model and the app could benefit from less code and one less domain model. In the end it
  looks like I can. This document will describe my finds.</p>
<p>
  In this document I use the term transaction metadata. This is data that is passed along
  with transactions but doesn&#39;t belong to a system/business model. This data is queried
  from Datomic and will together with some Datomic transaction data replace my <em>event-log</em>
  model completely.</p>
<p>
  While learning about this I created this Emacs Org mode document. With help from
  org-babel, CIDER and Clojure CLI I have a document where is can do a style of literate
  programming. <a href="https://www.youtube.com/watch?v=dljNabciEGg">Video about literate devops in Emacs</a>. I am on a learning path. If I have
  got something wrong please give me feedback via <a href="https://twitter.com/jherrlin">Twitter</a>. Would love that!</p>
</div>
</div>
<div id="outline-container-headline-3" class="outline-2">
<h2 id="headline-3">
Thanks to
</h2>
<div id="outline-text-headline-3" class="outline-text-2">
<ul>
<li><a href="https://www.youtube.com/watch?v=7lm3K8zVOdY">Lucas Cavalcanti &amp; Edward Wible - Exploring four hidden superpowers of Datomic</a>
Gave me idea of removing the &#34;event-log&#34; model from my domain models and embrace Datomic.</li>
<li><a href="https://augustl.com/blog/2019/datomic_querying_for_history_of_entity_v2/">August Lilleaas post, Datomic: Querying for the history of an entity (v2)</a>
Gave me a lot of inspiration and some of my code is <strong>heavily</strong> inspired from his post.</li>
</ul>
</div>
</div>
<div id="outline-container-headline-4" class="outline-2">
<h2 id="headline-4">
Dependencies
</h2>
<div id="outline-text-headline-4" class="outline-text-2">
<p>
  <a href="https://clojure.org/guides/deps_and_cli">Clojure Deps</a> handles dependencies. The <code class="verbatim">deps.edn</code> looks like this:</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">{</span><span class="ss">:deps</span> <span class="p">{</span><span class="nv">org.clojure/clojure</span> <span class="p">{</span><span class="ss">:mvn/version</span> <span class="s">&#34;1.10.1&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="nv">com.datomic/datomic-free</span> <span class="p">{</span><span class="ss">:mvn/version</span> <span class="s">&#34;0.9.5697&#34;</span><span class="p">}}}</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-5" class="outline-2">
<h2 id="headline-5">
In memory database.
</h2>
<div id="outline-text-headline-5" class="outline-text-2">
<p>
  Connect to a random, in memory database. If you would like to get a new fresh database,
  eval <code class="verbatim">(connect!)</code>.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">datomic.api</span> <span class="ss">:as</span> <span class="nv">d</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kd">defonce </span><span class="nv">state</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:datomic-connection</span> <span class="nv">nil</span><span class="p">}))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kd">defn </span><span class="nv">establish-connection</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Establish connection to random in memory database.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">uri</span> <span class="p">(</span><span class="nb">str </span><span class="s">&#34;datomic:mem://&#34;</span> <span class="p">(</span><span class="nf">gensym</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">d/create-database</span> <span class="nv">uri</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">d/connect</span> <span class="nv">uri</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kd">defn </span><span class="nv">conn</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Get the database connection&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="ss">:datomic-connection</span> <span class="o">@</span><span class="nv">state</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kd">defn </span><span class="nv">connect!</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Start a connection to a new random in memory database.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">db-conn</span> <span class="p">(</span><span class="nf">establish-connection</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nf">swap!</span> <span class="nv">state</span> <span class="nb">assoc </span><span class="ss">:datomic-connection</span> <span class="nv">db-conn</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="p">(</span><span class="nf">connect!</span><span class="p">)</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
Schema
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>
  Here is the schema. We will work with a person model. person-schema describes that
  model. The audit-schema describes transaction metadata that will be passed along with
  all transactions. This is the data that we are interested in when building the event
  log. <code class="verbatim">:audit/user</code> holds a reference to the user that made the transaction.
  <code class="verbatim">:audit/type</code> is the categorization of the transaction. It&#39;s also used as a unique value
  to make sure that we get correct data from our queries.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">(</span><span class="k">def </span><span class="nv">person-schema</span>
</span></span><span class="line"><span class="cl">    <span class="p">[{</span><span class="ss">:db/ident</span>       <span class="ss">:person/id</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/unique</span>      <span class="ss">:db.unique/identity</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/valueType</span>   <span class="ss">:db.type/uuid</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="p">{</span><span class="ss">:db/ident</span>       <span class="ss">:person/first-name</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/valueType</span>   <span class="ss">:db.type/string</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="p">{</span><span class="ss">:db/ident</span>       <span class="ss">:person/last-name</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/valueType</span>   <span class="ss">:db.type/string</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="p">{</span><span class="ss">:db/ident</span>       <span class="ss">:person/birth-year</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/valueType</span>   <span class="ss">:db.type/long</span><span class="p">}])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="k">def </span><span class="nv">audit-schema</span>
</span></span><span class="line"><span class="cl">    <span class="p">[{</span><span class="ss">:db/ident</span>       <span class="ss">:audit/user</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/valueType</span>   <span class="ss">:db.type/uuid</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="p">{</span><span class="ss">:db/ident</span>       <span class="ss">:audit/type</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:db/valueType</span>   <span class="ss">:db.type/keyword</span><span class="p">}])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; conj all schemas into a single vector</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="k">def </span><span class="nv">schema-set</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="p">(</span><span class="nf">conj</span>
</span></span><span class="line"><span class="cl">          <span class="nv">person-schema</span>
</span></span><span class="line"><span class="cl">          <span class="nv">audit-schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nf">flatten</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nf">set</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nf">vec</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">;; transact schema</span>
</span></span><span class="line"><span class="cl">  <span class="o">@</span><span class="p">(</span><span class="nf">d/transact</span> <span class="p">(</span><span class="nf">conn</span><span class="p">)</span> <span class="nv">schema-set</span><span class="p">)</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-7" class="outline-2">
<h2 id="headline-7">
Transactions
</h2>
<div id="outline-text-headline-7" class="outline-text-2">
<p>
  Create a person with the first name Anna and then make some changes to that entity. Anna
  will be our main target from now on. We also have a person called Erik. Erik is just
  here to make sure that we get the correct results. If we find data related to Erik,
  something is wrong.</p>
<p>
  Each transaction have a unique <code class="verbatim">:audit/type</code>. This is to make sure that we query the
  correct data later on.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="c1">;; uuid to the user that makes the transactions</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="k">def </span><span class="nv">user-id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="k">def </span><span class="nv">person</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:person/id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="ss">:person/first-name</span> <span class="s">&#34;Anna&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="ss">:person/last-name</span>  <span class="s">&#34;Anderss&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">@</span><span class="p">(</span><span class="nf">d/transact</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nv">person</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span><span class="ss">:audit/user</span> <span class="nv">user-id</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:audit/type</span> <span class="ss">:create</span><span class="p">}])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">@</span><span class="p">(</span><span class="nf">d/transact</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">[{</span><span class="ss">:person/id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span class="ss">:person/last-name</span> <span class="s">&#34;Andersson&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span><span class="ss">:audit/user</span> <span class="nv">user-id</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:audit/type</span> <span class="ss">:update1</span><span class="p">}])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">@</span><span class="p">(</span><span class="nf">d/transact</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">[{</span><span class="ss">:person/id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span class="ss">:person/birth-year</span> <span class="mi">1986</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span><span class="ss">:audit/user</span> <span class="nv">user-id</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:audit/type</span> <span class="ss">:update2</span><span class="p">}])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">@</span><span class="p">(</span><span class="nf">d/transact</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">[{</span><span class="ss">:person/id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span class="ss">:person/birth-year</span> <span class="mi">1987</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span><span class="ss">:audit/user</span> <span class="nv">user-id</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:audit/type</span> <span class="ss">:update3</span><span class="p">}])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">@</span><span class="p">(</span><span class="nf">d/transact</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="o">#</span><span class="ss">:person</span><span class="p">{</span><span class="ss">:id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;e193ad2b-3095-49ff-a6d8-47147db702fa&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="ss">:first-name</span> <span class="s">&#34;Erik&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="ss">:last-name</span> <span class="s">&#34;Eriksson&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="p">{</span><span class="ss">:audit/user</span> <span class="nv">user-id</span>
</span></span><span class="line"><span class="cl">      <span class="ss">:audit/type</span> <span class="ss">:error</span><span class="p">}])</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-8" class="outline-2">
<h2 id="headline-8">
Quick look at Anna
</h2>
<div id="outline-text-headline-8" class="outline-text-2">
<p>
  Query and pull Anna to see that all the transactions where successful.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">d/q</span> <span class="o">&#39;</span><span class="p">[</span><span class="ss">:find</span> <span class="p">(</span><span class="nf">pull</span> <span class="nv">?e</span> <span class="p">[</span><span class="nv">*</span><span class="p">])</span> <span class="nv">.</span>
</span></span><span class="line"><span class="cl">         <span class="ss">:in</span> <span class="nv">$</span> <span class="nv">?id</span>
</span></span><span class="line"><span class="cl">         <span class="ss">:where</span> <span class="p">[</span><span class="nv">?e</span> <span class="ss">:person/id</span> <span class="nv">?id</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">))</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">)</span></span></span></code></pre></div>
</div>
<p>
  This is the result and Anna looks correct.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:db/id</span> <span class="mi">17592186045418</span>,
</span></span><span class="line"><span class="cl"> <span class="ss">:person/first-name</span> <span class="s">&#34;Anna&#34;</span>,
</span></span><span class="line"><span class="cl"> <span class="ss">:person/last-name</span> <span class="s">&#34;Andersson&#34;</span>,
</span></span><span class="line"><span class="cl"> <span class="ss">:person/birth-year</span> <span class="mi">1987</span>,
</span></span><span class="line"><span class="cl"> <span class="ss">:person/id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">}</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-9" class="outline-2">
<h2 id="headline-9">
Transaction metadata
</h2>
<div id="outline-text-headline-9" class="outline-text-2">
<p>
  Lets look at what metadata we can get from the transactions we did on Anna.</p>
<p>
  The history database gives access to all of the datoms in the database. Not just recent
  ones. This gives us the ability to ask for all of the transactions related to a entity.</p>
<p>
  It&#39;s not possible to <code class="verbatim">pull</code> from the history database. This example uses two databases
  to enable pulls.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="p">(</span><span class="nf">d/q</span> <span class="o">&#39;</span><span class="p">{</span><span class="ss">:find</span>  <span class="p">[(</span><span class="nf">pull</span> <span class="nv">?audit</span> <span class="p">[</span><span class="ss">:audit/user</span> <span class="ss">:audit/type</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                      <span class="p">(</span><span class="nf">pull</span> <span class="nv">?tx</span>    <span class="p">[[</span><span class="ss">:db/txInstant</span> <span class="ss">:as</span> <span class="ss">:audit/datetime</span><span class="p">]])]</span>
</span></span><span class="line"><span class="cl">              <span class="ss">:in</span>    <span class="p">[</span><span class="nv">$history-db</span> <span class="nv">$</span> <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">              <span class="ss">:where</span> <span class="p">[[</span><span class="nv">$history-db</span> <span class="nv">?history-e</span> <span class="ss">:person/id</span>  <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                      <span class="p">[</span><span class="nv">$history-db</span> <span class="nv">?history-e</span> <span class="nv">?attr</span>       <span class="nv">_</span>          <span class="nv">?tx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                      <span class="p">[</span><span class="nv">$</span>           <span class="nv">?audit</span>     <span class="ss">:audit/type</span> <span class="nv">_</span>          <span class="nv">?tx</span><span class="p">]]}</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">d/history</span> <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">)</span> <span class="c1">;; Annas :person/id</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">a</span> <span class="nv">b</span><span class="p">]]</span> <span class="p">(</span><span class="nb">merge </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nb">sort-by </span><span class="ss">:audit/datetime</span><span class="p">))</span></span></span></code></pre></div>
</div>
<p>
  This is the results.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl"><span class="p">(</span><span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="ss">:type</span> <span class="ss">:create</span>,
</span></span><span class="line"><span class="cl">         <span class="ss">:datetime</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-18T19:49:02.305-00:00&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="ss">:type</span> <span class="ss">:update1</span>,
</span></span><span class="line"><span class="cl">         <span class="ss">:datetime</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-18T19:49:08.926-00:00&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="ss">:type</span> <span class="ss">:update2</span>,
</span></span><span class="line"><span class="cl">         <span class="ss">:datetime</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-18T19:49:14.794-00:00&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">         <span class="ss">:type</span> <span class="ss">:update3</span>,
</span></span><span class="line"><span class="cl">         <span class="ss">:datetime</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-18T19:49:26.063-00:00&#34;</span><span class="p">})</span></span></span></code></pre></div>
</div>
<p>
  We get a collection with all the changes made to Anna. For each change/transaction we
  get the author, timestamp and our categorization.</p>
</div>
</div>
<div id="outline-container-headline-10" class="outline-2">
<h2 id="headline-10">
Metadata together with entity attribute
</h2>
<div id="outline-text-headline-10" class="outline-text-2">
<p>
  This is more or less the same as above. But here we retrieve the first name on the most
  recent version of Anna. In the next section we use this value to create an event log
  message.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">d/q</span> <span class="o">&#39;</span><span class="p">{</span><span class="ss">:find</span>  <span class="p">[(</span><span class="nf">pull</span> <span class="nv">?audit</span> <span class="p">[</span><span class="ss">:audit/user</span> <span class="ss">:audit/type</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                 <span class="p">(</span><span class="nf">pull</span> <span class="nv">?tx</span>    <span class="p">[[</span><span class="ss">:db/txInstant</span> <span class="ss">:as</span> <span class="ss">:audit/datetime</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">                 <span class="nv">?person-name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">         <span class="ss">:in</span>    <span class="p">[</span><span class="nv">$history-db</span> <span class="nv">$</span> <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">         <span class="ss">:where</span> <span class="p">[[</span><span class="nv">$history-db</span> <span class="nv">?history-e</span>  <span class="ss">:person/id</span>         <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                 <span class="p">[</span><span class="nv">$history-db</span> <span class="nv">?history-e</span>  <span class="nv">_</span>                  <span class="nv">_</span>            <span class="nv">?tx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                 <span class="p">[</span><span class="nv">$</span>           <span class="nv">?audit</span>      <span class="ss">:audit/type</span>        <span class="nv">_</span>            <span class="nv">?tx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                 <span class="p">[</span><span class="nv">$</span>           <span class="nv">?e</span>          <span class="ss">:person/id</span>         <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                 <span class="p">[</span><span class="nv">$</span>           <span class="nv">?e</span>          <span class="ss">:person/first-name</span> <span class="nv">?person-name</span><span class="p">]]}</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">d/history</span> <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">       <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">)</span></span></span></code></pre></div>
</div>
<p>
  The result is truncated.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">[[</span><span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="ss">:type</span> <span class="ss">:update1</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:datetime</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-17T19:07:39.735-00:00&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;Anna&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   ,,,<span class="p">]</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-11" class="outline-2">
<h2 id="headline-11">
Event log
</h2>
<div id="outline-text-headline-11" class="outline-text-2">
<p>
  Now lets assemble it and create a collection with event log strings and a timestamp.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">(</span><span class="kd">defmulti </span><span class="nv">event-log-msg</span> <span class="ss">:audit/type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kd">defmethod </span><span class="nv">event-log-msg</span> <span class="ss">:create</span> <span class="p">[{</span><span class="ss">:audit/keys</span> <span class="p">[</span><span class="nv">user</span><span class="p">]</span> <span class="ss">:keys</span> <span class="p">[</span><span class="nv">entity</span><span class="p">]}]</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">str </span><span class="s">&#34;User &#34;</span> <span class="nv">user</span> <span class="s">&#34; created &#34;</span> <span class="nv">entity</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kd">defmethod </span><span class="nv">event-log-msg</span> <span class="ss">:update1</span> <span class="p">[{</span><span class="ss">:audit/keys</span> <span class="p">[</span><span class="nv">user</span><span class="p">]</span> <span class="ss">:keys</span> <span class="p">[</span><span class="nv">entity</span><span class="p">]}]</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">str </span><span class="s">&#34;User &#34;</span> <span class="nv">user</span> <span class="s">&#34; updated &#34;</span> <span class="nv">entity</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="kd">defmethod </span><span class="nv">event-log-msg</span> <span class="ss">:default</span> <span class="p">[{</span><span class="ss">:audit/keys</span> <span class="p">[</span><span class="nv">user</span><span class="p">]</span> <span class="ss">:keys</span> <span class="p">[</span><span class="nv">entity</span><span class="p">]}]</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nb">str </span><span class="s">&#34;User &#34;</span> <span class="nv">user</span> <span class="s">&#34; updated &#34;</span> <span class="nv">entity</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="p">(</span><span class="nf">d/q</span> <span class="o">&#39;</span><span class="p">{</span><span class="ss">:find</span>  <span class="p">[(</span><span class="nf">pull</span> <span class="nv">?audit</span> <span class="p">[</span><span class="ss">:audit/user</span> <span class="ss">:audit/type</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                      <span class="p">(</span><span class="nf">pull</span> <span class="nv">?tx</span>    <span class="p">[[</span><span class="ss">:db/txInstant</span> <span class="ss">:as</span> <span class="ss">:audit/datetime</span><span class="p">]])</span>
</span></span><span class="line"><span class="cl">                      <span class="nv">?person-name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">              <span class="ss">:in</span>    <span class="p">[</span><span class="nv">$history-db</span> <span class="nv">$</span> <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">              <span class="ss">:where</span> <span class="p">[[</span><span class="nv">$history-db</span> <span class="nv">?history-e</span>  <span class="ss">:person/id</span>         <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                      <span class="p">[</span><span class="nv">$history-db</span> <span class="nv">?history-e</span>  <span class="nv">_</span>                  <span class="nv">_</span>            <span class="nv">?tx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                      <span class="p">[</span><span class="nv">$</span>           <span class="nv">?audit</span>      <span class="ss">:audit/type</span>        <span class="nv">_</span>            <span class="nv">?tx</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                      <span class="p">[</span><span class="nv">$</span>           <span class="nv">?e</span>          <span class="ss">:person/id</span>         <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                      <span class="p">[</span><span class="nv">$</span>           <span class="nv">?e</span>          <span class="ss">:person/first-name</span> <span class="nv">?person-name</span><span class="p">]]}</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">d/history</span> <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">audit</span> <span class="nv">tx</span> <span class="nv">person-name</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nb">merge </span><span class="nv">audit</span> <span class="nv">tx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="p">(</span><span class="nb">assoc </span><span class="ss">:entity</span> <span class="nv">person-name</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nf">juxt</span> <span class="ss">:audit/datetime</span> <span class="nv">event-log-msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">       <span class="p">(</span><span class="nb">sort-by </span><span class="nv">first</span><span class="p">))</span></span></span></code></pre></div>
</div>
<p>
  Looks pretty good and gives a good overview of the transactions that is related to Anna.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl"><span class="p">([</span><span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-17T19:07:37.992-00:00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;User 19c14367-a230-4a8f-9cc3-b6bb72a23dcb created Anna&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-17T19:07:39.735-00:00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;User 19c14367-a230-4a8f-9cc3-b6bb72a23dcb updated Anna&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-17T19:07:43.242-00:00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;User 19c14367-a230-4a8f-9cc3-b6bb72a23dcb updated Anna&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-17T19:07:48.210-00:00&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s">&#34;User 19c14367-a230-4a8f-9cc3-b6bb72a23dcb updated Anna&#34;</span><span class="p">])</span></span></span></code></pre></div>
</div>
<p>
  By providing author and categorization to each transaction it is possible to trace the
  changes made to an entity and create an event log. The id and entity reference that
  existed in the event-log model is not needed. The transaction data replaces that need.
  This makes it possible for me to remove my <em>event-log</em> model and some of the code that&#39;s
  associated to it.</p>
</div>
</div>
<div id="outline-container-headline-12" class="outline-2">
<h2 id="headline-12">
Entity before and after each transaction
</h2>
<div id="outline-text-headline-12" class="outline-text-2">
<p>
  This is an elaboration on the event log and I am not sure I have use for in my current
  app. But <a href="https://augustl.com/blog/2019/datomic_querying_for_history_of_entity_v2/">August Lilleaas post</a> shows how to look at the entity before and after each
  transaction. This is really interesting and could be really useful when needed.</p>
<p>
  <a href="https://docs.datomic.com/on-prem/clojure/index.html#datomic.api/tx-%3Et">d/tx-&gt;t</a> returns the Datomic time the transaction was made. This is not the same as wall
  clock time. Instead it&#39;s and incremental number starting from 1000.</p>
<p>
  <a href="https://docs.datomic.com/on-prem/clojure/index.html#datomic.api/entity">d/entity</a> pulls an entity from a database and returns a dynamic/lazy map. To make it
  eager we use <code class="verbatim">into</code> on it.</p>
<p>
  <a href="https://docs.datomic.com/on-prem/clojure/index.html#datomic.api/as-of">d/as-of</a> returns a database for a specific time.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">db</span> <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="p">(</span><span class="nf">d/q</span> <span class="o">&#39;</span><span class="p">{</span><span class="ss">:find</span>  <span class="p">[</span><span class="nv">?e</span> <span class="nv">?tx</span> <span class="nv">?audit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="ss">:in</span>    <span class="p">[</span><span class="nv">$</span> <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="ss">:where</span> <span class="p">[[</span><span class="nv">?e</span>     <span class="ss">:person/id</span>  <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="p">[</span><span class="nv">?e</span>     <span class="nv">?attr</span>       <span class="nv">?val</span>        <span class="nv">?tx</span> <span class="nv">?added</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="p">[</span><span class="nv">?audit</span> <span class="ss">:audit/type</span> <span class="nv">_</span>           <span class="nv">?tx</span><span class="p">]]}</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nf">d/history</span> <span class="nv">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">)</span> <span class="c1">;; uuid of Anna</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">eid</span> <span class="nv">tx-eid</span> <span class="nv">audit-eid</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span><span class="ss">:timestamp</span> <span class="p">(</span><span class="ss">:db/txInstant</span> <span class="p">(</span><span class="nf">d/entity</span> <span class="nv">db</span> <span class="nv">tx-eid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="ss">:audit</span>     <span class="p">(</span><span class="nb">into </span><span class="p">{}</span> <span class="p">(</span><span class="nf">d/entity</span> <span class="nv">db</span> <span class="nv">audit-eid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="ss">:before</span>    <span class="p">(</span><span class="nb">into </span><span class="p">{}</span> <span class="p">(</span><span class="nf">d/entity</span> <span class="p">(</span><span class="nf">d/as-of</span> <span class="nv">db</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">d/tx-&gt;t</span> <span class="nv">tx-eid</span><span class="p">)))</span> <span class="nv">eid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="ss">:after</span>     <span class="p">(</span><span class="nb">into </span><span class="p">{}</span> <span class="p">(</span><span class="nf">d/entity</span> <span class="p">(</span><span class="nf">d/as-of</span> <span class="nv">db</span> <span class="nv">tx-eid</span><span class="p">)</span> <span class="nv">eid</span><span class="p">))}))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nb">sort-by </span><span class="ss">:timestamp</span><span class="p">)))</span></span></span></code></pre></div>
</div>
<p>
  The results.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">({</span><span class="ss">:timestamp</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-18T19:49:02.305-00:00&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:audit</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="ss">:type</span> <span class="ss">:create</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:before</span> <span class="p">{}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:after</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:person</span><span class="p">{</span><span class="ss">:first-name</span> <span class="s">&#34;Anna&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:last-name</span> <span class="s">&#34;Anderss&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span><span class="ss">:timestamp</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-18T19:49:08.926-00:00&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:audit</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="ss">:type</span> <span class="ss">:update1</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:before</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:person</span><span class="p">{</span><span class="ss">:first-name</span> <span class="s">&#34;Anna&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:last-name</span> <span class="s">&#34;Anderss&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:after</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:person</span><span class="p">{</span><span class="ss">:first-name</span> <span class="s">&#34;Anna&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:last-name</span> <span class="s">&#34;Andersson&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span><span class="ss">:timestamp</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-18T19:49:14.794-00:00&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:audit</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="ss">:type</span> <span class="ss">:update2</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:before</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:person</span><span class="p">{</span><span class="ss">:first-name</span> <span class="s">&#34;Anna&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:last-name</span> <span class="s">&#34;Andersson&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:after</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:person</span><span class="p">{</span><span class="ss">:first-name</span> <span class="s">&#34;Anna&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:last-name</span> <span class="s">&#34;Andersson&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:birth-year</span> <span class="mi">1986</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span><span class="ss">:timestamp</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-18T19:49:26.063-00:00&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:audit</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="ss">:type</span> <span class="ss">:update3</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:before</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:person</span><span class="p">{</span><span class="ss">:first-name</span> <span class="s">&#34;Anna&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:last-name</span> <span class="s">&#34;Andersson&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:birth-year</span> <span class="mi">1986</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:after</span>             <span class="c1">;; This is the most recent version of Anna</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:person</span><span class="p">{</span><span class="ss">:first-name</span> <span class="s">&#34;Anna&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:last-name</span> <span class="s">&#34;Andersson&#34;</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:birth-year</span> <span class="mi">1987</span>,
</span></span><span class="line"><span class="cl">             <span class="ss">:id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">}})</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-13" class="outline-2">
<h2 id="headline-13">
Changes in each transaction
</h2>
<div id="outline-text-headline-13" class="outline-text-2">
<p>
  Lets continue on the elaboration. This code is also <strong>heavily</strong> inspired of <a href="https://augustl.com/blog/2019/datomic_querying_for_history_of_entity_v2/">August
  Lilleaas post</a>.</p>
<p>
  Query and pull each transaction that is related to Anna. Return the changes that have
  been made in each transaction together with metadata.</p>
<p>
  Also something that&#39;s not useful for my application but something that could be really
  handy when needed.</p>
<p>
  <a href="https://docs.datomic.com/on-prem/clojure/index.html#datomic.api/ident">d/ident</a> return the attribute of the entity. Keywords like: <code class="verbatim">:person/first-name</code>,
  <code class="verbatim">:person/last-name</code> and so on.</p>
<p>
  <code class="verbatim">added</code> returns <code class="verbatim">true</code> if something was added and <code class="verbatim">false</code> if something was retracted.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">db</span> <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">))]</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="p">(</span><span class="nf">d/q</span> <span class="o">&#39;</span><span class="p">{</span><span class="ss">:find</span>  <span class="p">[</span><span class="nv">?tx</span> <span class="nv">?attr</span> <span class="nv">?val</span> <span class="nv">?added</span> <span class="nv">?audit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="ss">:in</span>    <span class="p">[</span><span class="nv">$</span> <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="ss">:where</span> <span class="p">[[</span><span class="nv">?e</span>     <span class="ss">:person/id</span>  <span class="nv">?person-id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="p">[</span><span class="nv">?e</span>     <span class="nv">?attr</span>       <span class="nv">?val</span>        <span class="nv">?tx</span> <span class="nv">?added</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="p">[</span><span class="nv">?audit</span> <span class="ss">:audit/type</span> <span class="nv">_</span>           <span class="nv">?tx</span><span class="p">]]}</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="nf">d/history</span> <span class="nv">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span><span class="p">)</span> <span class="c1">;; uuid of the person we audit</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nf">group-by</span> <span class="nv">first</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">tx</span> <span class="nv">transactions</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span><span class="ss">:timestamp</span> <span class="p">(</span><span class="ss">:db/txInstant</span> <span class="p">(</span><span class="nf">d/entity</span> <span class="nv">db</span> <span class="nv">tx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                 <span class="ss">:audit</span>     <span class="p">(</span><span class="nb">into </span><span class="p">{}</span> <span class="p">(</span><span class="nf">d/entity</span> <span class="nv">db</span> <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="nv">transactions</span> <span class="p">(</span><span class="nb">map </span><span class="nv">last</span><span class="p">)</span> <span class="nv">first</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                 <span class="ss">:changes</span>   <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="nv">transactions</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">_</span> <span class="nv">attr</span> <span class="nb">val </span><span class="nv">added</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">[(</span><span class="nf">d/ident</span> <span class="nv">db</span> <span class="nv">attr</span><span class="p">)</span> <span class="nb">val </span><span class="nv">added</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">                                 <span class="p">(</span><span class="nb">sort-by </span><span class="nv">last</span><span class="p">))}))</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="nb">sort-by </span><span class="ss">:timestamp</span><span class="p">)))</span></span></span></code></pre></div>
</div>
<p>
  The results.</p>
<div class="src src-clojure">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-clojure" data-lang="clojure"><span class="line"><span class="cl">  <span class="p">({</span><span class="ss">:timestamp</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-17T19:07:37.992-00:00&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:audit</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="ss">:type</span> <span class="ss">:create</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:changes</span>
</span></span><span class="line"><span class="cl">    <span class="p">([</span><span class="ss">:person/last-name</span> <span class="s">&#34;Anderss&#34;</span> <span class="nv">true</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">     <span class="p">[</span><span class="ss">:person/first-name</span> <span class="s">&#34;Anna&#34;</span> <span class="nv">true</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">     <span class="p">[</span><span class="ss">:person/id</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span class="nv">true</span><span class="p">])}</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span><span class="ss">:timestamp</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-17T19:07:39.735-00:00&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:audit</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="ss">:type</span> <span class="ss">:update1</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:changes</span>
</span></span><span class="line"><span class="cl">    <span class="p">([</span><span class="ss">:person/last-name</span> <span class="s">&#34;Anderss&#34;</span> <span class="nv">false</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">     <span class="p">[</span><span class="ss">:person/last-name</span> <span class="s">&#34;Andersson&#34;</span> <span class="nv">true</span><span class="p">])}</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span><span class="ss">:timestamp</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-17T19:07:43.242-00:00&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:audit</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="ss">:type</span> <span class="ss">:update2</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:changes</span>
</span></span><span class="line"><span class="cl">    <span class="p">([</span><span class="ss">:person/birth-year</span> <span class="mi">1986</span> <span class="nv">true</span><span class="p">])}</span>
</span></span><span class="line"><span class="cl">   <span class="p">{</span><span class="ss">:timestamp</span> <span class="o">#</span><span class="nv">inst</span> <span class="s">&#34;2020-05-17T19:07:48.210-00:00&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:audit</span>
</span></span><span class="line"><span class="cl">    <span class="o">#</span><span class="ss">:audit</span><span class="p">{</span><span class="ss">:user</span> <span class="o">#</span><span class="nv">uuid</span> <span class="s">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="ss">:type</span> <span class="ss">:update3</span><span class="p">}</span>,
</span></span><span class="line"><span class="cl">    <span class="ss">:changes</span>
</span></span><span class="line"><span class="cl">    <span class="p">([</span><span class="ss">:person/birth-year</span> <span class="mi">1986</span> <span class="nv">false</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">     <span class="p">[</span><span class="ss">:person/birth-year</span> <span class="mi">1987</span> <span class="nv">true</span><span class="p">])})</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-14" class="outline-2">
<h2 id="headline-14">
Conclusion
</h2>
<div id="outline-text-headline-14" class="outline-text-2">
<p>
  Datomic provides some really nice features. Features that makes you able to understand
  how a state came to be and who made it into that state. Some of the features is maybe
  overkill for my current use case. But I have no idea about the requirements of tomorrow.
  And the ability to look and understand the system is much worth.</p>
</div>
</div>

      
      <div class="related">
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>



</body>
</html>

