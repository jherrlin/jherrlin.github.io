<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Entity event log in Datomic | John Herrlin</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Entity event log in Datomic" />
<meta property="og:description" content="TL;DR   Create an event log from Datomic transactions that&#39;s related to an entity. Look at transaction metadata, diffs and the entity from different angles. Intro   I am pretty new to Datomic and writing a small Clojure app. In my domain models I have a model called event-log. This model is used to keep track of changes (mutations) in the system. It have the following attributes: author, datetime, entity, id, type." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jherrlin.github.io/posts/datomic-entity-event-log/" />
<meta property="article:published_time" content="2020-05-17T20:28:11+02:00" />
<meta property="article:modified_time" content="2020-05-17T20:28:11+02:00" />

		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Entity event log in Datomic"/>
<meta name="twitter:description" content="TL;DR   Create an event log from Datomic transactions that&#39;s related to an entity. Look at transaction metadata, diffs and the entity from different angles. Intro   I am pretty new to Datomic and writing a small Clojure app. In my domain models I have a model called event-log. This model is used to keep track of changes (mutations) in the system. It have the following attributes: author, datetime, entity, id, type."/>

	<link rel="stylesheet" href="/css/bundle.css">
	<link rel="stylesheet" href="/css/custom.css">
	<link rel="icon" href="/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="/icons/32.png" sizes="32x32" type="image/png">
		
</head>
<body>
	<header class="header">
	<a class="logo" href="/">John Herrlin</a>
	
</header>
	<div class="primary">
	
	<main class="main">
		
<nav class="breadcrumb block" aria-label="breadcrumb">
	<ol class="breadcrumb__list">
		
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="/">Home</a>
		</li>
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="/posts/">Posts</a>
		</li>
		<li class="breadcrumbs__item breadcrumb__item--active" aria-current="page">Entity event log in Datomic</li>
	</ol>
</nav>
		<div class="single block">
			<article class="entry">
	<div class="entry__meta meta mb">
	<time class="entry__meta-published meta-published" datetime="2020-05-17T20:28:11&#43;02:00">May 17, 2020</time>
<span class="entry__meta-categories meta-categories">
	<span class="meta-categories__list">Categories:
		<a class="meta-categories__link" href="/categories/database" rel="category">database</a>, 
		<a class="meta-categories__link" href="/categories/datomic" rel="category">datomic</a>, 
		<a class="meta-categories__link" href="/categories/clojure" rel="category">clojure</a>
	</span>
</span>
	</div>
				<h1 class="entry__title">Entity event log in Datomic</h1>
<details class="entry__toc toc" open>
	<summary class="toc__title">Table of Contents</summary>
	<nav id="TableOfContents">
<ul>
<li><a href="#headline-1">TL;DR</a>
</li>
<li><a href="#headline-2">Intro</a>
</li>
<li><a href="#headline-3">Thanks to</a>
</li>
<li><a href="#headline-4">Dependencies</a>
</li>
<li><a href="#headline-5">In memory database.</a>
</li>
<li><a href="#headline-6">Schema</a>
</li>
<li><a href="#headline-7">Transactions</a>
</li>
<li><a href="#headline-8">Quick look at Anna</a>
</li>
<li><a href="#headline-9">Transaction metadata</a>
</li>
<li><a href="#headline-10">Metadata together with entity attribute</a>
</li>
<li><a href="#headline-11">Event log</a>
</li>
<li><a href="#headline-12">Entity before and after each transaction</a>
</li>
<li><a href="#headline-13">Changes in each transaction</a>
</li>
<li><a href="#headline-14">Conclusion</a>
</li>
</ul>
</nav>
</details>
				<div class="entry__content">
<h2 id="headline-1">
TL;DR
</h2>
<p>
  Create an event log from Datomic transactions that&#39;s related to an entity. Look at
  transaction metadata, diffs and the entity from different angles.
</p>
<h2 id="headline-2">
Intro
</h2>
<p>
  I am pretty new to Datomic and writing a small Clojure app. In my domain models I have a
  model called <em>event-log</em>. This model is used to keep track of changes (mutations) in the
  system. It have the following attributes: <em>author</em>, <em>datetime</em>, <em>entity</em>, <em>id</em>, <em>type</em>.
  <em>author</em> is the user that made the change, <em>entity</em> is a reference to the entity that&#39;s
  changed, <em>datetime</em> is a timestamp of when the change occurred, <em>id</em> is a unique
  identifier of the event log entity and <em>type</em> is a categorization of the change. If a
  change was successful an <em>event-log</em> entity would be created. This implies that for each
  change, a new <em>event-log</em> entity will be created.
</p>
<p>
  After watching <a href="https://www.youtube.com/watch?v=7lm3K8zVOdY">this</a> talk I started to wonder if the <em>event-log</em> model was really needed
  in this app (it have only one database). Features of Datomic maybe could replace this
  model and the app could benefit from less code and one less domain model. In the end it
  looks like I can. This document will describe my finds.
</p>
<p>
  In this document I use the term transaction metadata. This is data that is passed along
  with transactions but doesn&#39;t belong to a system/business model. This data is queried
  from Datomic and will together with some Datomic transaction data replace my <em>event-log</em>
  model completely.
</p>
<p>
  While learning about this I created this Emacs Org mode document. With help from
  org-babel, CIDER and Clojure CLI I have a document where is can do a style of literate
  programming. <a href="https://www.youtube.com/watch?v=dljNabciEGg">Video about literate devops in Emacs</a>. I am on a learning path. If I have
  got something wrong please give me feedback via <a href="https://twitter.com/jherrlin">Twitter</a>. Would love that!
</p>
<h2 id="headline-3">
Thanks to
</h2>
<ul>
<li>
<p>
<a href="https://www.youtube.com/watch?v=7lm3K8zVOdY">Lucas Cavalcanti &amp; Edward Wible - Exploring four hidden superpowers of Datomic</a>
Gave me idea of removing the &#34;event-log&#34; model from my domain models and embrace Datomic.
</p>
</li>
<li>
<p>
<a href="https://augustl.com/blog/2019/datomic_querying_for_history_of_entity_v2/">August Lilleaas post, Datomic: Querying for the history of an entity (v2)</a>
Gave me a lot of inspiration and some of my code is <strong>heavily</strong> inspired from his post.
</p>
</li>
</ul>
<h2 id="headline-4">
Dependencies
</h2>
<p>
  <a href="https://clojure.org/guides/deps_and_cli">Clojure Deps</a> handles dependencies. The <code class="verbatim">deps.edn</code> looks like this:
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  {<span style="color:#e6db74">:deps</span> {org.clojure/clojure {<span style="color:#e6db74">:mvn/version</span> <span style="color:#e6db74">&#34;1.10.1&#34;</span>}
          com.datomic/datomic-free {<span style="color:#e6db74">:mvn/version</span> <span style="color:#e6db74">&#34;0.9.5697&#34;</span>}}}</code></pre></div>
</div>
<h2 id="headline-5">
In memory database.
</h2>
<p>
  Connect to a random, in memory database. If you would like to get a new fresh database,
  eval <code class="verbatim">(connect!)</code>.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#a6e22e">require</span> <span style="color:#f92672">&#39;</span>[datomic.api <span style="color:#e6db74">:as</span> d])

  (<span style="color:#66d9ef">def </span>state (<span style="color:#a6e22e">atom</span> {<span style="color:#e6db74">:datomic-connection</span> nil}))

  (<span style="color:#66d9ef">defn </span>establish-connection
    <span style="color:#e6db74">&#34;Establish connection to random in memory database.&#34;</span>
    []
    (<span style="color:#66d9ef">let </span>[uri (str <span style="color:#e6db74">&#34;datomic:mem://&#34;</span> (<span style="color:#a6e22e">gensym</span>))]
      (<span style="color:#a6e22e">d/create-database</span> uri)
      (<span style="color:#a6e22e">d/connect</span> uri)))

  (<span style="color:#66d9ef">defn </span>conn
    <span style="color:#e6db74">&#34;Get the database connection&#34;</span>
    []
    (<span style="color:#e6db74">:datomic-connection</span> <span style="color:#f92672">@</span>state))

  (<span style="color:#66d9ef">defn </span>connect!
    <span style="color:#e6db74">&#34;Start a connection to a new random in memory database.&#34;</span>
    []
    (<span style="color:#66d9ef">let </span>[db-conn (<span style="color:#a6e22e">establish-connection</span>)]
      (<span style="color:#a6e22e">swap!</span> state assoc <span style="color:#e6db74">:datomic-connection</span> db-conn)))

   (<span style="color:#a6e22e">connect!</span>)</code></pre></div>
</div>
<h2 id="headline-6">
Schema
</h2>
<p>
  Here is the schema. We will work with a person model. person-schema describes that
  model. The audit-schema describes transaction metadata that will be passed along with
  all transactions. This is the data that we are interested in when building the event
  log. <code class="verbatim">:audit/user</code> holds a reference to the user that made the transaction.
  <code class="verbatim">:audit/type</code> is the categorization of the transaction. It&#39;s also used as a unique value
  to make sure that we get correct data from our queries.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#66d9ef">def </span>person-schema
    [{<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:person/id</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/unique</span>      <span style="color:#e6db74">:db.unique/identity</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/uuid</span>}

     {<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:person/first-name</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/string</span>}

     {<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:person/last-name</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/string</span>}

     {<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:person/birth-year</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/long</span>}])

  (<span style="color:#66d9ef">def </span>audit-schema
    [{<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:audit/user</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/uuid</span>}

     {<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:audit/type</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/keyword</span>}])

  <span style="color:#75715e">;; conj all schemas into a single vector</span>
  (<span style="color:#66d9ef">def </span>schema-set
    (<span style="color:#a6e22e">-&gt;&gt;</span> (<span style="color:#a6e22e">conj</span>
          person-schema
          audit-schema)
         (<span style="color:#a6e22e">flatten</span>)
         (<span style="color:#a6e22e">set</span>)
         (<span style="color:#a6e22e">vec</span>)))

  <span style="color:#75715e">;; transact schema</span>
  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span> (<span style="color:#a6e22e">conn</span>) schema-set)</code></pre></div>
</div>
<h2 id="headline-7">
Transactions
</h2>
<p>
  Create a person with the first name Anna and then make some changes to that entity. Anna
  will be our main target from now on. We also have a person called Erik. Erik is just
  here to make sure that we get the correct results. If we find data related to Erik,
  something is wrong.
</p>
<p>
  Each transaction have a unique <code class="verbatim">:audit/type</code>. This is to make sure that we query the
  correct data later on.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  <span style="color:#75715e">;; uuid to the user that makes the transactions</span>
  (<span style="color:#66d9ef">def </span>user-id <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>)

  (<span style="color:#66d9ef">def </span>person
    {<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>
     <span style="color:#e6db74">:person/first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span>
     <span style="color:#e6db74">:person/last-name</span>  <span style="color:#e6db74">&#34;Anderss&#34;</span>})

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [person
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:create</span>}])

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [{<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Andersson&#34;</span>}
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:update1</span>}])

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [{<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1986</span>}
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:update2</span>}])

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [{<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1987</span>}
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:update3</span>}])

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [<span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;e193ad2b-3095-49ff-a6d8-47147db702fa&#34;</span>
              <span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Erik&#34;</span>
              <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Eriksson&#34;</span>}
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:create-not-ours</span>}])</code></pre></div>
</div>
<h2 id="headline-8">
Quick look at Anna
</h2>
<p>
  Query and pull Anna to see that all the transactions where successful.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>[<span style="color:#e6db74">:find</span> (<span style="color:#a6e22e">pull</span> ?e [*]) .
         <span style="color:#e6db74">:in</span> $ ?id
         <span style="color:#e6db74">:where</span> [?e <span style="color:#e6db74">:person/id</span> ?id]]
       (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>)) <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>)</code></pre></div>
</div>
<p>
  This is the results and Anna looks correct.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">{<span style="color:#e6db74">:db/id</span> <span style="color:#ae81ff">17592186045418</span>,
 <span style="color:#e6db74">:person/first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span>,
 <span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Andersson&#34;</span>,
 <span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1987</span>,
 <span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}</code></pre></div>
</div>
<h2 id="headline-9">
Transaction metadata
</h2>
<p>
  Lets look at what metadata we can get from the transactions we did on Anna.
</p>
<p>
  The history database gives access to all of the datoms in the database. Not just the
  recent ones. This gives us the ability to ask for all of the transactions related to a
  entity.
</p>
<p>
  It&#39;s not possible to <code class="verbatim">pull</code> from the history database. This example uses two databases
  to enable pulls.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#a6e22e">-&gt;&gt;</span> (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>{<span style="color:#e6db74">:find</span>  [(<span style="color:#a6e22e">pull</span> ?audit [<span style="color:#e6db74">:audit/user</span> <span style="color:#e6db74">:audit/type</span>])
                      (<span style="color:#a6e22e">pull</span> ?tx    [[<span style="color:#e6db74">:db/txInstant</span> <span style="color:#e6db74">:as</span> <span style="color:#e6db74">:audit/datetime</span>]])]
              <span style="color:#e6db74">:in</span>    [$history-db $ ?person-id]
              <span style="color:#e6db74">:where</span> [[$history-db ?history-e <span style="color:#e6db74">:person/id</span>  ?person-id]
                      [$history-db ?history-e ?attr       _          ?tx]
                      [$           ?audit     <span style="color:#e6db74">:audit/type</span> _          ?tx]]}
            (<span style="color:#a6e22e">d/history</span> (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>)))
            (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>))
            <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>) <span style="color:#75715e">;; Annas :person/id</span>
       (map (<span style="color:#66d9ef">fn </span>[[a b]] (merge a b)))
       (sort-by <span style="color:#e6db74">:audit/datetime</span>))</code></pre></div>
</div>
<p>
  This is the results.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
         <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:create</span>,
         <span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-18T19:49:02.305-00:00&#34;</span>}
 <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
         <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update1</span>,
         <span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-18T19:49:08.926-00:00&#34;</span>}
 <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
         <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update2</span>,
         <span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-18T19:49:14.794-00:00&#34;</span>}
 <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
         <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update3</span>,
         <span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-18T19:49:26.063-00:00&#34;</span>})</code></pre></div>
</div>
<p>
  We get a collection with all the changes made to Anna. For each change/transaction we
  get the author, timestamp and our categorization.
</p>
<h2 id="headline-10">
Metadata together with entity attribute
</h2>
<p>
  This is more or less the same as above. But here we retrieve the first name on the most
  recent version of Anna. In the next section we use this value to create an event log
  message.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>{<span style="color:#e6db74">:find</span>  [(<span style="color:#a6e22e">pull</span> ?audit [<span style="color:#e6db74">:audit/user</span> <span style="color:#e6db74">:audit/type</span>])
                 (<span style="color:#a6e22e">pull</span> ?tx    [[<span style="color:#e6db74">:db/txInstant</span> <span style="color:#e6db74">:as</span> <span style="color:#e6db74">:audit/datetime</span>]])
                 ?person-name]
         <span style="color:#e6db74">:in</span>    [$history-db $ ?person-id]
         <span style="color:#e6db74">:where</span> [[$history-db ?history-e  <span style="color:#e6db74">:person/id</span>         ?person-id]
                 [$history-db ?history-e  _                  _            ?tx]
                 [$           ?audit      <span style="color:#e6db74">:audit/type</span>        _            ?tx]
                 [$           ?e          <span style="color:#e6db74">:person/id</span>         ?person-id]
                 [$           ?e          <span style="color:#e6db74">:person/first-name</span> ?person-name]]}
       (<span style="color:#a6e22e">d/history</span> (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>)))
       (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>))
       <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>)</code></pre></div>
</div>
<p>
  The result is truncated.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  [[<span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
            <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update1</span>}
    <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-17T19:07:39.735-00:00&#34;</span>}
    <span style="color:#e6db74">&#34;Anna&#34;</span>]
   ,,,]</code></pre></div>
</div>
<h2 id="headline-11">
Event log
</h2>
<p>
  Now lets assemble it and create a collection with event log strings and a timestamp.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#66d9ef">defmulti </span>event-log-msg <span style="color:#e6db74">:audit/type</span>)
  (<span style="color:#66d9ef">defmethod </span>event-log-msg <span style="color:#e6db74">:create</span> [{<span style="color:#e6db74">:audit/keys</span> [user] <span style="color:#e6db74">:keys</span> [entity]}]
    (str <span style="color:#e6db74">&#34;User &#34;</span> user <span style="color:#e6db74">&#34; created &#34;</span> entity))
  (<span style="color:#66d9ef">defmethod </span>event-log-msg <span style="color:#e6db74">:update1</span> [{<span style="color:#e6db74">:audit/keys</span> [user] <span style="color:#e6db74">:keys</span> [entity]}]
    (str <span style="color:#e6db74">&#34;User &#34;</span> user <span style="color:#e6db74">&#34; updated &#34;</span> entity))
  (<span style="color:#66d9ef">defmethod </span>event-log-msg <span style="color:#e6db74">:default</span> [{<span style="color:#e6db74">:audit/keys</span> [user] <span style="color:#e6db74">:keys</span> [entity]}]
    (str <span style="color:#e6db74">&#34;User &#34;</span> user <span style="color:#e6db74">&#34; updated &#34;</span> entity))

  (<span style="color:#a6e22e">-&gt;&gt;</span> (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>{<span style="color:#e6db74">:find</span>  [(<span style="color:#a6e22e">pull</span> ?audit [<span style="color:#e6db74">:audit/user</span> <span style="color:#e6db74">:audit/type</span>])
                      (<span style="color:#a6e22e">pull</span> ?tx    [[<span style="color:#e6db74">:db/txInstant</span> <span style="color:#e6db74">:as</span> <span style="color:#e6db74">:audit/datetime</span>]])
                      ?person-name]
              <span style="color:#e6db74">:in</span>    [$history-db $ ?person-id]
              <span style="color:#e6db74">:where</span> [[$history-db ?history-e  <span style="color:#e6db74">:person/id</span>         ?person-id]
                      [$history-db ?history-e  _                  _            ?tx]
                      [$           ?audit      <span style="color:#e6db74">:audit/type</span>        _            ?tx]
                      [$           ?e          <span style="color:#e6db74">:person/id</span>         ?person-id]
                      [$           ?e          <span style="color:#e6db74">:person/first-name</span> ?person-name]]}
            (<span style="color:#a6e22e">d/history</span> (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>)))
            (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>))
            <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>)
       (map (<span style="color:#66d9ef">fn </span>[[a t person-name]]
              (-&gt; (merge a t)
                  (assoc <span style="color:#e6db74">:entity</span> person-name))))
       (map (<span style="color:#66d9ef">fn </span>[x] [(<span style="color:#e6db74">:audit/datetime</span> x) (<span style="color:#a6e22e">event-log-msg</span> x)]))
       (sort-by first))</code></pre></div>
</div>
<p>
  Looks pretty good and gives a good overview of the transactions that is related to Anna.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">([<span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-17T19:07:37.992-00:00&#34;</span>
  <span style="color:#e6db74">&#34;User 19c14367-a230-4a8f-9cc3-b6bb72a23dcb created Anna&#34;</span>]
 [<span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-17T19:07:39.735-00:00&#34;</span>
  <span style="color:#e6db74">&#34;User 19c14367-a230-4a8f-9cc3-b6bb72a23dcb updated Anna&#34;</span>]
 [<span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-17T19:07:43.242-00:00&#34;</span>
  <span style="color:#e6db74">&#34;User 19c14367-a230-4a8f-9cc3-b6bb72a23dcb updated Anna&#34;</span>]
 [<span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-17T19:07:48.210-00:00&#34;</span>
  <span style="color:#e6db74">&#34;User 19c14367-a230-4a8f-9cc3-b6bb72a23dcb updated Anna&#34;</span>])</code></pre></div>
</div>
<p>
  By providing author and categorization to each transaction I now have everything I need
  to trace the changes made to an entity and we are able to create an event log. The
  attributes <em>id</em> and the reference to the entity is not longer of any use. The
  transaction id is the unique identifier but not that relevant anymore. The <em>entity</em>
  reference is created automagically in the Datomic transaction. This makes it possible
  for me to remove my <em>event-log</em> model and some of the code that&#39;s associated to it.
</p>
<h2 id="headline-12">
Entity before and after each transaction
</h2>
<p>
  This is an elaboration on the event log and I am not sure I have use for in my current
  app. But <a href="https://augustl.com/blog/2019/datomic_querying_for_history_of_entity_v2/">August Lilleaas post</a> shows how to look at the entity before and after each
  transaction. This is really interesting and could be really useful when needed.
</p>
<p>
  <a href="https://docs.datomic.com/on-prem/clojure/index.html#datomic.api/tx-%3Et">d/tx-&gt;t</a> returns the Datomic time the transaction was made. This is not the same as wall
  clock time. Instead it&#39;s and incremental number starting from 1000.
</p>
<p>
  <a href="https://docs.datomic.com/on-prem/clojure/index.html#datomic.api/entity">d/entity</a> pulls an entity from a database and returns a dynamic/lazy map. To make it
  eager we use <code class="verbatim">into</code> on it.
</p>
<p>
  <a href="https://docs.datomic.com/on-prem/clojure/index.html#datomic.api/as-of">d/as-of</a> returns a database for a specific time.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#66d9ef">let </span>[db (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>))]
    (<span style="color:#a6e22e">-&gt;&gt;</span> (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>{<span style="color:#e6db74">:find</span>  [?e ?tx ?audit]
                <span style="color:#e6db74">:in</span>    [$ ?person-id]
                <span style="color:#e6db74">:where</span> [[?e     <span style="color:#e6db74">:person/id</span>  ?person-id]
                        [?e     ?attr       ?val        ?tx ?added]
                        [?audit <span style="color:#e6db74">:audit/type</span> _           ?tx]]}
              (<span style="color:#a6e22e">d/history</span> db)
              <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>) <span style="color:#75715e">;; uuid of Anna</span>
         (map (<span style="color:#66d9ef">fn </span>[[eid tx-eid audit-eid]]
                {<span style="color:#e6db74">:t-dec</span>     (dec (<span style="color:#a6e22e">d/tx-&gt;t</span> tx-eid))
                 <span style="color:#e6db74">:t</span>         (<span style="color:#a6e22e">d/tx-&gt;t</span> tx-eid)
                 <span style="color:#e6db74">:timestamp</span> (<span style="color:#e6db74">:db/txInstant</span> (<span style="color:#a6e22e">d/entity</span> db tx-eid))
                 <span style="color:#e6db74">:audit</span>     (into {} (<span style="color:#a6e22e">d/entity</span> db audit-eid))
                 <span style="color:#e6db74">:before</span>    (into {} (<span style="color:#a6e22e">d/entity</span> (<span style="color:#a6e22e">d/as-of</span> db (dec (<span style="color:#a6e22e">d/tx-&gt;t</span> tx-eid))) eid))
                 <span style="color:#e6db74">:after</span>     (into {} (<span style="color:#a6e22e">d/entity</span> (<span style="color:#a6e22e">d/as-of</span> db tx-eid) eid))}))
         (sort-by <span style="color:#e6db74">:timestamp</span>)))</code></pre></div>
</div>
<p>
  The results.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">({<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-18T19:49:02.305-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:create</span>},
  <span style="color:#e6db74">:before</span> {},
  <span style="color:#e6db74">:after</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Anderss&#34;</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-18T19:49:08.926-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update1</span>},
  <span style="color:#e6db74">:before</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Anderss&#34;</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>},
  <span style="color:#e6db74">:after</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Andersson&#34;</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-18T19:49:14.794-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update2</span>},
  <span style="color:#e6db74">:before</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Andersson&#34;</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>},
  <span style="color:#e6db74">:after</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Andersson&#34;</span>,
           <span style="color:#e6db74">:birth-year</span> <span style="color:#ae81ff">1986</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-18T19:49:26.063-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update3</span>},
  <span style="color:#e6db74">:before</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Andersson&#34;</span>,
           <span style="color:#e6db74">:birth-year</span> <span style="color:#ae81ff">1986</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>},
  <span style="color:#e6db74">:after</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Andersson&#34;</span>,
           <span style="color:#e6db74">:birth-year</span> <span style="color:#ae81ff">1987</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}})</code></pre></div>
</div>
<h2 id="headline-13">
Changes in each transaction
</h2>
<p>
  Lets continue on the elaboration. This code is also <strong>heavily</strong> inspired of <a href="https://augustl.com/blog/2019/datomic_querying_for_history_of_entity_v2/">August
  Lilleaas post</a>.
</p>
<p>
  Query and pull each transaction that is related to Anna. Return the changes that have
  been made in each transaction together with metadata.
</p>
<p>
  Also something that&#39;s not useful for my application but something that could be really
  handy when needed.
</p>
<p>
  <a href="https://docs.datomic.com/on-prem/clojure/index.html#datomic.api/ident">d/ident</a> return the attribute of the entity. Keywords like: <code class="verbatim">:person/first-name</code>,
  <code class="verbatim">:person/last-name</code> and so on.
</p>
<p>
  <code class="verbatim">added</code> returns <code class="verbatim">true</code> if something was added and <code class="verbatim">false</code> if something was retracted.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#66d9ef">let </span>[db (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>))]
    (<span style="color:#a6e22e">-&gt;&gt;</span> (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>{<span style="color:#e6db74">:find</span>  [?tx ?attr ?val ?added ?audit]
                <span style="color:#e6db74">:in</span>    [$ ?person-id]
                <span style="color:#e6db74">:where</span> [[?e     <span style="color:#e6db74">:person/id</span>  ?person-id]
                        [?e     ?attr       ?val        ?tx ?added]
                        [?audit <span style="color:#e6db74">:audit/type</span> _           ?tx]]}
              (<span style="color:#a6e22e">d/history</span> db)
              <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>) <span style="color:#75715e">;; uuid of the person we audit</span>
         (<span style="color:#a6e22e">group-by</span> first)
         (<span style="color:#a6e22e">mapv</span> (<span style="color:#66d9ef">fn </span>[[tx transactions]]
                 {<span style="color:#e6db74">:timestamp</span> (<span style="color:#e6db74">:db/txInstant</span> (<span style="color:#a6e22e">d/entity</span> db tx))
                  <span style="color:#e6db74">:audit</span>     (into {} (<span style="color:#a6e22e">d/entity</span> db (<span style="color:#a6e22e">-&gt;&gt;</span> transactions (map last) first)))
                  <span style="color:#e6db74">:changes</span>   (<span style="color:#a6e22e">-&gt;&gt;</span> (map (<span style="color:#66d9ef">fn </span>[[_ attr val added]]
                                         [(<span style="color:#a6e22e">d/ident</span> db attr) val added])
                                       transactions)
                                  (sort-by last))}))
         (sort-by <span style="color:#e6db74">:timestamp</span>)))</code></pre></div>
</div>
<p>
  Results.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">({<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-17T19:07:37.992-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:create</span>},
  <span style="color:#e6db74">:changes</span>
  ([<span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Anderss&#34;</span> true]
   [<span style="color:#e6db74">:person/first-name</span> <span style="color:#e6db74">&#34;Anna&#34;</span> true]
   [<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> true])}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-17T19:07:39.735-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update1</span>},
  <span style="color:#e6db74">:changes</span>
  ([<span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Anderss&#34;</span> false]
   [<span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Andersson&#34;</span> true])}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-17T19:07:43.242-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update2</span>},
  <span style="color:#e6db74">:changes</span> ([<span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1986</span> true])}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-17T19:07:48.210-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update3</span>},
  <span style="color:#e6db74">:changes</span>
  ([<span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1986</span> false] [<span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1987</span> true])})</code></pre></div>
</div>
<h2 id="headline-14">
Conclusion
</h2>
<p>
  Datomic provides some really nice features. Features that makes you able to understand
  how a state came to be and who made it into that state. Some of the features is maybe
  overkill for my current use case. But I have no idea about the requirements of tomorrow.
  And the ability to look and understand the system is much worth.
</p>
</div>
				
				<footer class="entry__footer">
					
					
<div class="entry__share share">
	<a class="share__link btn" title="Share on Twitter" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fjherrlin.github.io%2fposts%2fdatomic-entity-event-log%2f&amp;text=Entity%20event%20log%20in%20Datomic" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Share on Twitter', 'width=800,height=450,resizable=yes,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
	</a>
</div>
				</footer>
				
			</article>
		</div>
	</main>
	
	



	

	</div>
	<footer class="footer">
<div class="footer__social social">
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="mailto:jherrlin@gmail.com">
			<svg class="social__icon" aria-label="Email" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M299 268l124 106c-4 4-10 7-17 7H106c-7 0-13-3-17-7l124-106 43 38 43-38zm-43 13L89 138c4-4 10-7 17-7h300c7 0 13 3 17 7L256 281zm54-23l121-105v208L310 258zM81 153l121 105L81 361V153z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://twitter.com/jherrlin">
			<svg class="social__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/jherrlin">
			<svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
		</a>
</div>
	<div class="footer__copyright">© 2020 John Herrlin. <span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span></div>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script src="/js/custom.js"></script>
</body>
</html>