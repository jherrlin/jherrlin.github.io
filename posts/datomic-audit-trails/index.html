<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#1b1b1b">
	<title>Audit trail Datomic entity | John Herrlin</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Audit trail Datomic entity" />
<meta property="og:description" content="TL;DR   Audit trail Datomic transactions that is related to an entity. Look at transaction meta data, diffs and the entity from different angles. Intro   This document is my own learning notes and designed to be used in Emacs org mode with help from org-babel, CIDER and Clojure CLI. This gives me live interaction abilities with the document and the source code blocks. I am on a learning path, if I have got something wrong please give me feedback via twitter." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jherrlin.github.io/posts/datomic-audit-trails/" />
<meta property="article:published_time" content="2020-05-15T08:28:11+02:00" />
<meta property="article:modified_time" content="2020-05-15T08:28:11+02:00" />

		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Audit trail Datomic entity"/>
<meta name="twitter:description" content="TL;DR   Audit trail Datomic transactions that is related to an entity. Look at transaction meta data, diffs and the entity from different angles. Intro   This document is my own learning notes and designed to be used in Emacs org mode with help from org-babel, CIDER and Clojure CLI. This gives me live interaction abilities with the document and the source code blocks. I am on a learning path, if I have got something wrong please give me feedback via twitter."/>

	<link rel="stylesheet" href="/css/bundle.css">
	<link rel="stylesheet" href="/css/custom.css">
	<link rel="icon" href="/icons/16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="/icons/32.png" sizes="32x32" type="image/png">
		
</head>
<body>
	<header class="header">
	<a class="logo" href="/">John Herrlin</a>
	
</header>
	<div class="primary">
	
	<main class="main">
		
<nav class="breadcrumb block" aria-label="breadcrumb">
	<ol class="breadcrumb__list">
		
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="/">Home</a>
		</li>
		<li class="breadcrumb__item">
			<a class="breadcrumbs__link" href="/posts/">Posts</a>
		</li>
		<li class="breadcrumbs__item breadcrumb__item--active" aria-current="page">Audit trail Datomic entity</li>
	</ol>
</nav>
		<div class="single block">
			<article class="entry">
	<div class="entry__meta meta mb">
	<time class="entry__meta-published meta-published" datetime="2020-05-15T08:28:11&#43;02:00">May 15, 2020</time>
<span class="entry__meta-categories meta-categories">
	<span class="meta-categories__list">Categories:
		<a class="meta-categories__link" href="/categories/database" rel="category">database</a>, 
		<a class="meta-categories__link" href="/categories/datomic" rel="category">datomic</a>, 
		<a class="meta-categories__link" href="/categories/clojure" rel="category">clojure</a>
	</span>
</span>
	</div>
				<h1 class="entry__title">Audit trail Datomic entity</h1>
<details class="entry__toc toc" open>
	<summary class="toc__title">Table of Contents</summary>
	<nav id="TableOfContents">
<ul>
<li><a href="#headline-1">TL;DR</a>
</li>
<li><a href="#headline-2">Intro</a>
</li>
<li><a href="#headline-3">Thanks to</a>
</li>
<li><a href="#headline-4">Prerequisite</a>
</li>
<li><a href="#headline-5">Connect to in memory database.</a>
</li>
<li><a href="#headline-6">Schema</a>
</li>
<li><a href="#headline-7">Transact the schema</a>
</li>
<li><a href="#headline-8">Person transactions</a>
</li>
<li><a href="#headline-9">Have a quick look at Kalle</a>
</li>
<li><a href="#headline-10">Audit trail Kalle for meta data</a>
</li>
<li><a href="#headline-11">Audit trail data together with some entity data</a>
</li>
<li><a href="#headline-12">Entity before and after each transaction</a>
</li>
<li><a href="#headline-13">Changes in each transaction</a>
</li>
</ul>
</nav>
</details>
				<div class="entry__content">
<h2 id="headline-1">
TL;DR
</h2>
<p>
  Audit trail Datomic transactions that is related to an entity. Look at transaction meta
  data, diffs and the entity from different angles.
</p>
<h2 id="headline-2">
Intro
</h2>
<p>
  This document is my own learning notes and designed to be used in Emacs org mode with
  help from org-babel, CIDER and Clojure CLI. This gives me live interaction abilities
  with the document and the source code blocks. I am on a learning path, if I have got
  something wrong please give me feedback via twitter. Would love that!
</p>
<h2 id="headline-3">
Thanks to
</h2>
<ul>
<li>
<p>
<a href="https://www.youtube.com/watch?v=7lm3K8zVOdY">Lucas Cavalcanti &amp; Edward Wible - Exploring four hidden superpowers of Datomic</a>
Gave me idea of removing the &#34;event-log&#34; entity from my business models and embrace Datomic.
</p>
</li>
<li>
<p>
<a href="https://augustl.com/blog/2019/datomic_querying_for_history_of_entity_v2/">August Lilleaas post, Datomic: Querying for the history of an entity (v2)</a>
Gave me a lot of inspiration and some of my code is <strong>heavily</strong> inspired from his post.
</p>
</li>
</ul>
<h2 id="headline-4">
Prerequisite
</h2>
<p>
  <a href="https://clojure.org/guides/deps_and_cli">Clojure Deps</a> to handle dependencies. <code class="verbatim">deps.edn</code> looks like this:
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  {<span style="color:#e6db74">:deps</span> {org.clojure/clojure {<span style="color:#e6db74">:mvn/version</span> <span style="color:#e6db74">&#34;1.10.1&#34;</span>}
          com.datomic/datomic-free {<span style="color:#e6db74">:mvn/version</span> <span style="color:#e6db74">&#34;0.9.5697&#34;</span>}}}</code></pre></div>
</div>
<h2 id="headline-5">
Connect to in memory database.
</h2>
<p>
  Set up a random in memory database. If you would like to get a new fresh database, eval
  <code class="verbatim">(connect!)</code>.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#a6e22e">require</span> <span style="color:#f92672">&#39;</span>[datomic.api <span style="color:#e6db74">:as</span> d])

  (<span style="color:#66d9ef">def </span>state (<span style="color:#a6e22e">atom</span> {<span style="color:#e6db74">:datomic-connection</span> nil}))

  (<span style="color:#66d9ef">defn </span>random-in-memory-uri
    <span style="color:#e6db74">&#34;Generate a random in memory Datomic URI&#34;</span>
    []
    (str <span style="color:#e6db74">&#34;datomic:mem://&#34;</span> (<span style="color:#a6e22e">gensym</span>)))

  (<span style="color:#66d9ef">defn </span>establish-connection
    <span style="color:#e6db74">&#34;Establish connection to URL&#34;</span>
    [uri]
    (<span style="color:#a6e22e">d/create-database</span> uri)
    (<span style="color:#a6e22e">d/connect</span> uri))

  (<span style="color:#66d9ef">defn </span>conn
    <span style="color:#e6db74">&#34;Get the database connection&#34;</span>
    []
    (<span style="color:#e6db74">:datomic-connection</span> <span style="color:#f92672">@</span>state))

  (<span style="color:#66d9ef">defn </span>connect!
    <span style="color:#e6db74">&#34;Start a connection to a new random in memory database.&#34;</span>
    []
    (<span style="color:#66d9ef">let </span>[db-conn (<span style="color:#a6e22e">establish-connection</span> (<span style="color:#a6e22e">random-in-memory-uri</span>))]
      (<span style="color:#a6e22e">swap!</span> state assoc <span style="color:#e6db74">:datomic-connection</span> db-conn)))

   (<span style="color:#a6e22e">connect!</span>)</code></pre></div>
</div>
<h2 id="headline-6">
Schema
</h2>
<p>
  The person-schema is describing a Person model. The audit-schema holds meta data values
  that will be passed with the Person mutation transactions. This are the values that we
  are interested in when building the audit trail.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#66d9ef">def </span>person-schema
    [{<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:person/id</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/unique</span>      <span style="color:#e6db74">:db.unique/identity</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/uuid</span>}

     {<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:person/first-name</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/string</span>}

     {<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:person/last-name</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/string</span>}

     {<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:person/birth-year</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/long</span>}])

  (<span style="color:#66d9ef">def </span>audit-schema
    [{<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:audit/user</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/uuid</span>}

     {<span style="color:#e6db74">:db/ident</span>       <span style="color:#e6db74">:audit/type</span>
      <span style="color:#e6db74">:db/cardinality</span> <span style="color:#e6db74">:db.cardinality/one</span>
      <span style="color:#e6db74">:db/valueType</span>   <span style="color:#e6db74">:db.type/keyword</span>}])</code></pre></div>
</div>
<h2 id="headline-7">
Transact the schema
</h2>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#66d9ef">def </span>schema-set
    (<span style="color:#a6e22e">-&gt;&gt;</span> (<span style="color:#a6e22e">conj</span>
          person-schema
          audit-schema)
         (<span style="color:#a6e22e">flatten</span>)
         (<span style="color:#a6e22e">set</span>)
         (<span style="color:#a6e22e">vec</span>)))

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span> (<span style="color:#a6e22e">conn</span>) schema-set)</code></pre></div>
</div>
<h2 id="headline-8">
Person transactions
</h2>
<p>
  In this section we transact some data into Datomic. Each transaction provides meta data
  about the transaction. Things like what user did the transaction, what type of
  transaction we categorize it as.
</p>
<p>
  Each transaction have a unique <code class="verbatim">:audit/type</code>. The reason for this is to make it easy to
  see if we query something wrong later on.
</p>
<p>
  We have 2 persons in the database. Kalle and Erik. Kalle is the person we mutate and
  audit trail later on. Erik is just there to make sure that we don&#39;t get any of his data.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  <span style="color:#75715e">;; uuid to the user that makes the mutations</span>
  (<span style="color:#66d9ef">def </span>user-id <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>)

  (<span style="color:#66d9ef">def </span>person
    {<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>
     <span style="color:#e6db74">:person/first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span>
     <span style="color:#e6db74">:person/last-name</span>  <span style="color:#e6db74">&#34;Karlss&#34;</span>})

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [person
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:create</span>}])

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [{<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Karlsson&#34;</span>}
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:update1</span>}])

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [{<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1986</span>}
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:update2</span>}])

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [{<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> <span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1987</span>}
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:update3</span>}])

  <span style="color:#f92672">@</span>(<span style="color:#a6e22e">d/transact</span>
    (<span style="color:#a6e22e">conn</span>)
    [<span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;e193ad2b-3095-49ff-a6d8-47147db702fa&#34;</span>
              <span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Erik&#34;</span>
              <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Eriksson&#34;</span>}
     {<span style="color:#e6db74">:audit/user</span> user-id
      <span style="color:#e6db74">:audit/type</span> <span style="color:#e6db74">:create-not-ours</span>}])</code></pre></div>
</div>
<h2 id="headline-9">
Have a quick look at Kalle
</h2>
<p>
  Query and pull Kalle to see that all the mutations where successful.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>[<span style="color:#e6db74">:find</span> (<span style="color:#a6e22e">pull</span> ?e [*]) .
         <span style="color:#e6db74">:in</span> $ ?id
         <span style="color:#e6db74">:where</span> [?e <span style="color:#e6db74">:person/id</span> ?id]]
       (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>)) <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>)</code></pre></div>
</div>
<p>
  This is the results.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">{<span style="color:#e6db74">:db/id</span> <span style="color:#ae81ff">17592186045418</span>,
 <span style="color:#e6db74">:person/first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span>,
 <span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Karlsson&#34;</span>,
 <span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1987</span>,
 <span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}</code></pre></div>
</div>
<h2 id="headline-10">
Audit trail Kalle for meta data
</h2>
<p>
  Query and pull the meta data passed to each transaction for the Kalle entity.
</p>
<p>
  The history database gives access to all of the datoms in the database. Not just the
  most recent ones. This gives us the ability to ask for all of the transactions related
  to a entity.
</p>
<p>
  It&#39;s not possible to <code class="verbatim">pull</code> from the history database. This example provides two
  databases to the query to make it able to pull. In a real scenario I think the query and
  the pull are separate concerns.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#a6e22e">-&gt;&gt;</span> (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>{<span style="color:#e6db74">:find</span>  [(<span style="color:#a6e22e">pull</span> ?audit [<span style="color:#e6db74">:audit/user</span> <span style="color:#e6db74">:audit/type</span>])
                      (<span style="color:#a6e22e">pull</span> ?tx    [[<span style="color:#e6db74">:db/txInstant</span> <span style="color:#e6db74">:as</span> <span style="color:#e6db74">:audit/datetime</span>]])]
              <span style="color:#e6db74">:in</span>    [$history-db $ ?person-id]
              <span style="color:#e6db74">:where</span> [[$history-db ?history-e <span style="color:#e6db74">:person/id</span>  ?person-id]
                      [$history-db ?history-e ?attr       _          ?tx]
                      [$           ?audit     <span style="color:#e6db74">:audit/type</span> _          ?tx]]}
            (<span style="color:#a6e22e">d/history</span> (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>)))
            (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>))
            <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>)
       (map (<span style="color:#66d9ef">fn </span>[[a b]] (merge a b)))
       (sort-by <span style="color:#e6db74">:audit/datetime</span>))</code></pre></div>
</div>
<p>
  This is the results.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
         <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:create</span>,
         <span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:17.696-00:00&#34;</span>}
 <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
         <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update1</span>,
         <span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:21.321-00:00&#34;</span>}
 <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
         <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update2</span>,
         <span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:24.688-00:00&#34;</span>}
 <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
         <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update3</span>,
         <span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:29.864-00:00&#34;</span>})</code></pre></div>
</div>
<h2 id="headline-11">
Audit trail data together with some entity data
</h2>
<p>
  This is more or less the same query as above. The only difference is that this query
  gets some attributes from the most recent entity facts.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>{<span style="color:#e6db74">:find</span>  [(<span style="color:#a6e22e">pull</span> ?audit [<span style="color:#e6db74">:audit/user</span> <span style="color:#e6db74">:audit/type</span>])
                 (<span style="color:#a6e22e">pull</span> ?tx    [[<span style="color:#e6db74">:db/txInstant</span> <span style="color:#e6db74">:as</span> <span style="color:#e6db74">:audit/datetime</span>]])
                 ?person-name]
         <span style="color:#e6db74">:in</span>    [$history-db $ ?person-id]
         <span style="color:#e6db74">:where</span> [[$history-db ?history-e  <span style="color:#e6db74">:person/id</span>         ?person-id]
                 [$history-db ?history-e  ?attr              _            ?tx]
                 [$           ?audit      <span style="color:#e6db74">:audit/type</span>        _            ?tx]
                 [$           ?e          <span style="color:#e6db74">:person/id</span>         ?person-id]
                 [$           ?e          <span style="color:#e6db74">:person/first-name</span> ?person-name]]}
       (<span style="color:#a6e22e">d/history</span> (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>)))
       (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>))
       <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>)</code></pre></div>
</div>
<p>
  Result is truncated.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  [[<span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
            <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update1</span>}
    <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:datetime</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:21.321-00:00&#34;</span>}
    <span style="color:#e6db74">&#34;Kalle&#34;</span>]
   ...]</code></pre></div>
</div>
<h2 id="headline-12">
Entity before and after each transaction
</h2>
<p>
  Query and pull each transaction that is related to Kalle. Show how the entity looks
  before and after the transaction.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#66d9ef">let </span>[db (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>))]
    (<span style="color:#a6e22e">-&gt;&gt;</span> (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>{<span style="color:#e6db74">:find</span>  [?e ?tx ?audit]
                <span style="color:#e6db74">:in</span>    [$ ?person-id]
                <span style="color:#e6db74">:where</span> [[?e     <span style="color:#e6db74">:person/id</span>  ?person-id]
                        [?e     ?attr       ?val        ?tx ?added]
                        [?audit <span style="color:#e6db74">:audit/type</span> _           ?tx]]}
              (<span style="color:#a6e22e">d/history</span> db)
              <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>) <span style="color:#75715e">;; uid of the person we audit</span>
         (map (<span style="color:#66d9ef">fn </span>[[eid tx-eid audit-eid]]
                {<span style="color:#e6db74">:timestamp</span> (<span style="color:#e6db74">:db/txInstant</span> (<span style="color:#a6e22e">d/entity</span> db tx-eid))
                 <span style="color:#e6db74">:audit</span>     (into {} (<span style="color:#a6e22e">d/entity</span> db audit-eid)) <span style="color:#75715e">;; db/entity returns a lazy</span>
                 <span style="color:#e6db74">:before</span>    (into {} (<span style="color:#a6e22e">d/entity</span> (<span style="color:#a6e22e">d/as-of</span> db (dec (<span style="color:#a6e22e">d/tx-&gt;t</span> tx-eid))) eid))
                 <span style="color:#e6db74">:after</span>     (into {} (<span style="color:#a6e22e">d/entity</span> (<span style="color:#a6e22e">d/as-of</span> db tx-eid) eid))}))
         (sort-by <span style="color:#e6db74">:timestamp</span>)))</code></pre></div>
</div>
<p>
  This is the result.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">({<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:17.696-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:create</span>},
  <span style="color:#e6db74">:before</span> {},
  <span style="color:#e6db74">:after</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Karlss&#34;</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:21.321-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update1</span>},
  <span style="color:#e6db74">:before</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Karlss&#34;</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>},
  <span style="color:#e6db74">:after</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Karlsson&#34;</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:24.688-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update2</span>},
  <span style="color:#e6db74">:before</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Karlsson&#34;</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>},
  <span style="color:#e6db74">:after</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Karlsson&#34;</span>,
           <span style="color:#e6db74">:birth-year</span> <span style="color:#ae81ff">1986</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:29.864-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update3</span>},
  <span style="color:#e6db74">:before</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Karlsson&#34;</span>,
           <span style="color:#e6db74">:birth-year</span> <span style="color:#ae81ff">1986</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>},
  <span style="color:#e6db74">:after</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:person</span>{<span style="color:#e6db74">:first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span>,
           <span style="color:#e6db74">:last-name</span> <span style="color:#e6db74">&#34;Karlsson&#34;</span>,
           <span style="color:#e6db74">:birth-year</span> <span style="color:#ae81ff">1987</span>,
           <span style="color:#e6db74">:id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>}})</code></pre></div>
</div>
<h2 id="headline-13">
Changes in each transaction
</h2>
<p>
  Query and pull each transaction that is related to Kalle. Return the changes that have
  been made in each transaction together with audit data.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">  (<span style="color:#66d9ef">let </span>[db (<span style="color:#a6e22e">d/db</span> (<span style="color:#a6e22e">conn</span>))]
    (<span style="color:#a6e22e">-&gt;&gt;</span> (<span style="color:#a6e22e">d/q</span> <span style="color:#f92672">&#39;</span>{<span style="color:#e6db74">:find</span>  [?tx ?attr ?val ?added ?audit]
                <span style="color:#e6db74">:in</span>    [$ ?person-id]
                <span style="color:#e6db74">:where</span> [[?e     <span style="color:#e6db74">:person/id</span>  ?person-id]
                        [?e     ?attr       ?val        ?tx ?added]
                        [?audit <span style="color:#e6db74">:audit/type</span> _           ?tx]]}
              (<span style="color:#a6e22e">d/history</span> db)
              <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span>) <span style="color:#75715e">;; uuid of the person we audit</span>
         (<span style="color:#a6e22e">group-by</span> first)
         (<span style="color:#a6e22e">mapv</span> (<span style="color:#66d9ef">fn </span>[[tx transactions]]
                 {<span style="color:#e6db74">:timestamp</span> (<span style="color:#e6db74">:db/txInstant</span> (<span style="color:#a6e22e">d/entity</span> db tx))
                  <span style="color:#e6db74">:audit</span>     (into {} (<span style="color:#a6e22e">d/entity</span> db (<span style="color:#a6e22e">-&gt;&gt;</span> transactions (map last) first))) <span style="color:#75715e">;; db/entity returns a lazy</span>
                  <span style="color:#e6db74">:changes</span>   (<span style="color:#a6e22e">-&gt;&gt;</span> (map (<span style="color:#66d9ef">fn </span>[[_ attr val added]]
                                         [(<span style="color:#a6e22e">d/ident</span> db attr) val added])
                                       transactions)
                                  (sort-by last))}))
         (sort-by <span style="color:#e6db74">:timestamp</span>)))</code></pre></div>
</div>
<p>
  This is the results.
</p>
<div class="src src-clojure">
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">({<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:17.696-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:create</span>},
  <span style="color:#e6db74">:changes</span>
  ([<span style="color:#e6db74">:person/first-name</span> <span style="color:#e6db74">&#34;Kalle&#34;</span> true]
   [<span style="color:#e6db74">:person/id</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;431a2745-07b7-4850-80d5-075c78b306d1&#34;</span> true]
   [<span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Karlss&#34;</span> true])}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:21.321-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update1</span>},
  <span style="color:#e6db74">:changes</span>
  ([<span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Karlss&#34;</span> false]
   [<span style="color:#e6db74">:person/last-name</span> <span style="color:#e6db74">&#34;Karlsson&#34;</span> true])}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:24.688-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update2</span>},
  <span style="color:#e6db74">:changes</span> ([<span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1986</span> true])}
 {<span style="color:#e6db74">:timestamp</span> <span style="color:#f92672">#</span>inst <span style="color:#e6db74">&#34;2020-05-15T09:23:29.864-00:00&#34;</span>,
  <span style="color:#e6db74">:audit</span>
  <span style="color:#f92672">#</span><span style="color:#e6db74">:audit</span>{<span style="color:#e6db74">:user</span> <span style="color:#f92672">#</span>uuid <span style="color:#e6db74">&#34;19c14367-a230-4a8f-9cc3-b6bb72a23dcb&#34;</span>,
          <span style="color:#e6db74">:type</span> <span style="color:#e6db74">:update3</span>},
  <span style="color:#e6db74">:changes</span>
  ([<span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1986</span> false] [<span style="color:#e6db74">:person/birth-year</span> <span style="color:#ae81ff">1987</span> true])})</code></pre></div>
</div>
</div>
				
				<footer class="entry__footer">
					
					
<div class="entry__share share">
	<a class="share__link btn" title="Share on Twitter" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fjherrlin.github.io%2fposts%2fdatomic-audit-trails%2f&amp;text=Audit%20trail%20Datomic%20entity" target="_blank" rel="noopener noreferrer" onclick="window.open(this.href, 'Share on Twitter', 'width=800,height=450,resizable=yes,toolbar=0,status=0'); return false">
		<svg class="share__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
	</a>
</div>
				</footer>
				
			</article>
		</div>
	</main>
	
	



	

	</div>
	<footer class="footer">
<div class="footer__social social">
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="mailto:jherrlin@gmail.com">
			<svg class="social__icon" aria-label="Email" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M299 268l124 106c-4 4-10 7-17 7H106c-7 0-13-3-17-7l124-106 43 38 43-38zm-43 13L89 138c4-4 10-7 17-7h300c7 0 13 3 17 7L256 281zm54-23l121-105v208L310 258zM81 153l121 105L81 361V153z"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://twitter.com/jherrlin">
			<svg class="social__icon" aria-label="Twitter" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
		</a>
		<a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/jherrlin">
			<svg class="social__icon" aria-label="Github" role="img" width="32" height="32" viewBox="0 0 512 512"><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
		</a>
</div>
	<div class="footer__copyright">© 2020 John Herrlin. <span class="footer__copyright-credits">Powered by <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/vimux/binario" rel="nofollow noopener" target="_blank">Binario</a> theme.</span></div>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>

<script src="/js/custom.js"></script>
</body>
</html>